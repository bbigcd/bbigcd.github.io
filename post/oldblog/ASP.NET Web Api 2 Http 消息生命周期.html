<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>ASP.NET Web Api 2 Http 消息生命周期 | bbigcd</title>
    <meta name="description" content="Make more time">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.0cbbf90a.css" as="style"><link rel="preload" href="/assets/js/app.fa3e3824.js" as="script"><link rel="preload" href="/assets/js/2.230529bd.js" as="script"><link rel="preload" href="/assets/js/25.dd992728.js" as="script"><link rel="prefetch" href="/assets/js/10.c93fe082.js"><link rel="prefetch" href="/assets/js/11.4bf3ae7f.js"><link rel="prefetch" href="/assets/js/12.01c45e0e.js"><link rel="prefetch" href="/assets/js/13.d9d858d9.js"><link rel="prefetch" href="/assets/js/14.00d956f4.js"><link rel="prefetch" href="/assets/js/15.679c6742.js"><link rel="prefetch" href="/assets/js/16.abbcd59e.js"><link rel="prefetch" href="/assets/js/17.1f5585d5.js"><link rel="prefetch" href="/assets/js/18.149d6c4f.js"><link rel="prefetch" href="/assets/js/19.4dd5acbe.js"><link rel="prefetch" href="/assets/js/20.874851b7.js"><link rel="prefetch" href="/assets/js/21.e8fab656.js"><link rel="prefetch" href="/assets/js/22.74ef4341.js"><link rel="prefetch" href="/assets/js/23.0815466b.js"><link rel="prefetch" href="/assets/js/24.3923d245.js"><link rel="prefetch" href="/assets/js/26.f9a0d7a7.js"><link rel="prefetch" href="/assets/js/27.54f139b7.js"><link rel="prefetch" href="/assets/js/28.070cfa63.js"><link rel="prefetch" href="/assets/js/29.eb08d370.js"><link rel="prefetch" href="/assets/js/3.447720c6.js"><link rel="prefetch" href="/assets/js/30.e66848e4.js"><link rel="prefetch" href="/assets/js/31.0438d4db.js"><link rel="prefetch" href="/assets/js/32.daf1012d.js"><link rel="prefetch" href="/assets/js/33.9f79b5b3.js"><link rel="prefetch" href="/assets/js/34.086724a3.js"><link rel="prefetch" href="/assets/js/35.90c07cc0.js"><link rel="prefetch" href="/assets/js/36.056ad52c.js"><link rel="prefetch" href="/assets/js/4.0f091beb.js"><link rel="prefetch" href="/assets/js/5.4c5d2735.js"><link rel="prefetch" href="/assets/js/6.a4af8558.js"><link rel="prefetch" href="/assets/js/7.8feeb04b.js"><link rel="prefetch" href="/assets/js/8.1af69973.js"><link rel="prefetch" href="/assets/js/9.e612d3ea.js">
    <link rel="stylesheet" href="/assets/css/0.styles.0cbbf90a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">bbigcd</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/netcore/" class="nav-link">NetCore</a></div><div class="nav-item"><a href="/csharp/" class="nav-link">CSharp</a></div><div class="nav-item"><a href="/post/" class="nav-link router-link-active">Other</a></div><div class="nav-item"><a href="/about-me/" class="nav-link">AboutMe</a></div><div class="nav-item"><a href="https://www.github.com/bbigcd" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/netcore/" class="nav-link">NetCore</a></div><div class="nav-item"><a href="/csharp/" class="nav-link">CSharp</a></div><div class="nav-item"><a href="/post/" class="nav-link router-link-active">Other</a></div><div class="nav-item"><a href="/about-me/" class="nav-link">AboutMe</a></div><div class="nav-item"><a href="https://www.github.com/bbigcd" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>旧博客内容</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/post/oldblog/ASP.NET Web Api 2 Http 消息生命周期.html" class="active sidebar-link">ASP.NET Web Api 2 Http 消息生命周期</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/post/oldblog/ASP.NET中关于Async和Await的概述.html" class="sidebar-link">ASP.NET 中关于Async和Await的概述【译】</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/post/oldblog/AutoMapper使用学习笔记.html" class="sidebar-link">AutoMapper使用学习笔记</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/post/oldblog/Dapper框架.html" class="sidebar-link">Dapper框架</a></li><li><a href="/post/oldblog/MongoDB-CSharp-Driver-快速入门指南.html" class="sidebar-link">MongoDB C# Driver 快速入门指南</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/post/oldblog/NLog教程.html" class="sidebar-link">NLog教程</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/post/oldblog/微服务-Consul服务治理发现.html" class="sidebar-link">微服务 - Consul服务治理发现</a></li><li><a href="/post/oldblog/微服务-JWT.html" class="sidebar-link">微服务 - JWT 算法</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/post/oldblog/微服务-Ocelot API 网关.html" class="sidebar-link">微服务 - Ocelot API 网关</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/post/oldblog/微服务-Polly熔断降级.html" class="sidebar-link">微服务 - Polly熔断降级</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/post/oldblog/Redis-CSharp-Driver.html" class="sidebar-link">Redis C# Driver - StackExchange.Redis</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p><a href="https://www.asp.net/media/4071077/aspnet-web-api-poster.pdf" target="_blank" rel="noopener noreferrer">ASP.NET Web Api 2 Http 消息生命周期<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><img src="https://upload-images.jianshu.io/upload_images/1366611-540605ae803d1901.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p> <h3 id="iis-hosting-与-owin-self-hosting"><a href="#iis-hosting-与-owin-self-hosting" class="header-anchor">#</a> IIS Hosting 与 OWIN Self-Hosting</h3> <ul><li>IIS Hosting
是指将 ASP.NET Web Api 程序发布到 IIS Manager 的方式运行</li> <li>OWIN Self-Hosting
是指ASP.NET Web Api程序以自宿主的方式运行，不依赖 IIS ，在 .NET Core 中，默认以自宿主的方式运行程序，其服务器为 <a href="https://docs.microsoft.com/zh-cn/aspnet/core/fundamentals/servers/kestrel?view=aspnetcore-2.1&amp;tabs=aspnetcore2x" target="_blank" rel="noopener noreferrer">kestrel<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></li></ul> <h3 id="http-request"><a href="#http-request" class="header-anchor">#</a> HTTP Request</h3> <p>无论是以哪种方式运行，当接收到一个 HTTP Request 的时候，HTTP Request 消息在第一时间会被转化为一个 HttpRequestMessage 对象，这个 HttpRequestMessage 提供了对 HTTP 消息的强类型访问对象；</p> <p><img src="https://upload-images.jianshu.io/upload_images/1366611-9c08cce25e5c6f75.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p> <h3 id="delegatinghandler"><a href="#delegatinghandler" class="header-anchor">#</a> DelegatingHandler</h3> <p>HTTP message handles (HTTP 消息处理器)处于整个处理管道中的第一步，它们在进入时处理 HTTP 请求消息，在退出时处理 HTTP 响应消息。</p> <p>如果想自定义一个 message handle （消息处理器）,可以从 DelegatingHandler 这个类派生得到，并且可以添加多个自定义的消息处理器。</p> <p>消息处理器可以是全局的，也可以是指定给特定的一个路由的。每个路由中的消息处理器仅在该对应的路由被相应的请求匹配的时候触发。所有的路由消息处理器在路由表中配置。</p> <blockquote><p>值得注意的是，消息处理器可以直接创建一个响应，使得管道中的其余操作都被跳过。</p></blockquote> <h3 id="httproutingdispatcher"><a href="#httproutingdispatcher" class="header-anchor">#</a> HttpRoutingDispatcher</h3> <p>如果Route.Handle为空，则进入 HttpControllerDispatcher ，否则进入 Per-route Message Handles 中进行路由处理器处理，再进入 HttpMessageHandler</p> <h3 id="httpmessagehandler"><a href="#httpmessagehandler" class="header-anchor">#</a> HttpMessageHandler</h3> <p>HttpMessageHandler 消息处理器可以调用 HttpControllerDispatcher 并返回到主管道中，或者直接提供一个自定义的返回标志。</p> <h3 id="httpcontrollerdispatcher"><a href="#httpcontrollerdispatcher" class="header-anchor">#</a> HttpControllerDispatcher</h3> <p>HttpControllerDispatcher 消息处理可以创建一个响应，使得管道中的其余操作都被跳过。
其主要的职责为创建 API 控制器</p> <p><img src="https://upload-images.jianshu.io/upload_images/1366611-465993ab89acefed.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p> <p>分两个步骤</p> <ul><li>选择控制器类型</li> <li>激活控制器（初始化控制器）</li></ul> <p>激活控制器后进入控制器消息管道中</p> <h4 id="select-controller-action"><a href="#select-controller-action" class="header-anchor">#</a> Select Controller Action</h4> <p><img src="https://upload-images.jianshu.io/upload_images/1366611-879a6cc2cb7dba01.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p> <p>依据请求的 URL ，创建 Api 控制器，并选着对应的
Action，经由 IHttpActionInvoker 处理后返回 HttpActionDescriptor（Action的描述）</p> <h4 id="authentication-filters"><a href="#authentication-filters" class="header-anchor">#</a> Authentication Filters</h4> <p>授权过滤器，请求进入后，如果对应的请求需要进行授权校验，则依据 Authentication Filters 来进行权限校验，同样的，如果授权失败，则授权过滤器会直接创建一个错误响应，使得管道中的其余操作都被跳过。
授权通过后，进入模型绑定。</p> <p><img src="https://upload-images.jianshu.io/upload_images/1366611-a49f2eda0a3af391.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p> <h4 id="model-binding"><a href="#model-binding" class="header-anchor">#</a> Model Binding</h4> <p>模型绑定使用请求为 Action 的参数创建值。这些值在调用 Action 时传递给 Action 。</p> <p><img src="https://upload-images.jianshu.io/upload_images/1366611-867143ea94d088a9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p> <p>请求信息中包含了：</p> <ul><li>URL</li> <li>Headers</li> <li>Entity-body</li></ul> <p>对应的绑定方式也有三种</p> <ul><li>FormatterParameterBinding：如果请求体不为空，则会匹配该类型的模型绑定方式；</li> <li>ModelBinderParameterBinding： 默认的绑定方式，即从 URL 的路径和查询字符串中进行简单类型绑定；</li> <li>HttpParameterBinding：自定义参数绑定可以读取任何 http 请求。</li></ul> <p>接下来进入 Action 过滤器</p> <h4 id="action-filter"><a href="#action-filter" class="header-anchor">#</a> Action Filter</h4> <p>Action Filter 会被调用两次，分别为 Action 执行前和 Action 执行之后。ActionFilterAttribute类中包含了 Action Filter 的两个方法（包含异步方法）</p> <ul><li>OnActionExecuting - Action执行开始前触发</li> <li>OnActionExecuted - Action执行结束后触发</li></ul> <p>接下来就是进入到 Action 中</p> <h4 id="invoke-action"><a href="#invoke-action" class="header-anchor">#</a> Invoke Action</h4> <p><img src="https://upload-images.jianshu.io/upload_images/1366611-66490b6cbc3675e3.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p> <p>调用 控制器的 Action ，使用 HttpActionContext 作为绑定和模型状态</p> <p>如果发生异常，则进入 Exception Filter中</p> <h4 id="exception-filters"><a href="#exception-filters" class="header-anchor">#</a> Exception Filters</h4> <p>未处理的异常会被路由到异常过滤器。
Exception Filter 会创建一个错误的响应，并结束此次请求过程。</p> <h4 id="result-conversion"><a href="#result-conversion" class="header-anchor">#</a> Result Conversion</h4> <p>如果请求正确执行，就会进入到结果转换过程中
<img src="https://upload-images.jianshu.io/upload_images/1366611-d48f85cff478adfb.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p> <p>Action 的返回值会被转换为HttpResponseMessage。</p> <ul><li>HttpResponseMessage</li></ul> <blockquote><p>如果返回的是 HttpResponseMessage，则直接通过</p></blockquote> <ul><li>void</li></ul> <blockquote><p>如果返回的是 void，那么会创建一个状态码为204的响应，表示执行成功且无返回值。</p></blockquote> <ul><li>IHttpActionResult</li></ul> <blockquote><p>如果返回的是 IHttpActionResult，则会调用 ExecuteAync 去创建一个 HttpResponseMessage。</p></blockquote> <ul><li>Other types</li></ul> <blockquote><p>如果都不是以上三种类型，则一个 media-type  格式化程序序列化该值并将其写入消息体。</p></blockquote></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time"> 2019年 12月 28日 15:53:50</span></div></footer> <div class="page-nav"><p class="inner"><!----> <span class="next"><a href="/post/oldblog/ASP.NET中关于Async和Await的概述.html">ASP.NET 中关于Async和Await的概述【译】</a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.fa3e3824.js" defer></script><script src="/assets/js/2.230529bd.js" defer></script><script src="/assets/js/25.dd992728.js" defer></script>
  </body>
</html>
