<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>MongoDB C# Driver 快速入门指南 | bbigcd</title>
    <meta name="description" content="Make more time">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.0cbbf90a.css" as="style"><link rel="preload" href="/assets/js/app.fa3e3824.js" as="script"><link rel="preload" href="/assets/js/2.230529bd.js" as="script"><link rel="preload" href="/assets/js/29.eb08d370.js" as="script"><link rel="prefetch" href="/assets/js/10.c93fe082.js"><link rel="prefetch" href="/assets/js/11.4bf3ae7f.js"><link rel="prefetch" href="/assets/js/12.01c45e0e.js"><link rel="prefetch" href="/assets/js/13.d9d858d9.js"><link rel="prefetch" href="/assets/js/14.00d956f4.js"><link rel="prefetch" href="/assets/js/15.679c6742.js"><link rel="prefetch" href="/assets/js/16.abbcd59e.js"><link rel="prefetch" href="/assets/js/17.1f5585d5.js"><link rel="prefetch" href="/assets/js/18.149d6c4f.js"><link rel="prefetch" href="/assets/js/19.4dd5acbe.js"><link rel="prefetch" href="/assets/js/20.874851b7.js"><link rel="prefetch" href="/assets/js/21.e8fab656.js"><link rel="prefetch" href="/assets/js/22.74ef4341.js"><link rel="prefetch" href="/assets/js/23.0815466b.js"><link rel="prefetch" href="/assets/js/24.3923d245.js"><link rel="prefetch" href="/assets/js/25.dd992728.js"><link rel="prefetch" href="/assets/js/26.f9a0d7a7.js"><link rel="prefetch" href="/assets/js/27.54f139b7.js"><link rel="prefetch" href="/assets/js/28.070cfa63.js"><link rel="prefetch" href="/assets/js/3.447720c6.js"><link rel="prefetch" href="/assets/js/30.e66848e4.js"><link rel="prefetch" href="/assets/js/31.0438d4db.js"><link rel="prefetch" href="/assets/js/32.daf1012d.js"><link rel="prefetch" href="/assets/js/33.9f79b5b3.js"><link rel="prefetch" href="/assets/js/34.086724a3.js"><link rel="prefetch" href="/assets/js/35.90c07cc0.js"><link rel="prefetch" href="/assets/js/36.056ad52c.js"><link rel="prefetch" href="/assets/js/4.0f091beb.js"><link rel="prefetch" href="/assets/js/5.4c5d2735.js"><link rel="prefetch" href="/assets/js/6.a4af8558.js"><link rel="prefetch" href="/assets/js/7.8feeb04b.js"><link rel="prefetch" href="/assets/js/8.1af69973.js"><link rel="prefetch" href="/assets/js/9.e612d3ea.js">
    <link rel="stylesheet" href="/assets/css/0.styles.0cbbf90a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">bbigcd</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/netcore/" class="nav-link">NetCore</a></div><div class="nav-item"><a href="/csharp/" class="nav-link">CSharp</a></div><div class="nav-item"><a href="/post/" class="nav-link router-link-active">Other</a></div><div class="nav-item"><a href="/about-me/" class="nav-link">AboutMe</a></div><div class="nav-item"><a href="https://www.github.com/bbigcd" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/netcore/" class="nav-link">NetCore</a></div><div class="nav-item"><a href="/csharp/" class="nav-link">CSharp</a></div><div class="nav-item"><a href="/post/" class="nav-link router-link-active">Other</a></div><div class="nav-item"><a href="/about-me/" class="nav-link">AboutMe</a></div><div class="nav-item"><a href="https://www.github.com/bbigcd" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>旧博客内容</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/post/oldblog/ASP.NET Web Api 2 Http 消息生命周期.html" class="sidebar-link">ASP.NET Web Api 2 Http 消息生命周期</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/post/oldblog/ASP.NET中关于Async和Await的概述.html" class="sidebar-link">ASP.NET 中关于Async和Await的概述【译】</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/post/oldblog/AutoMapper使用学习笔记.html" class="sidebar-link">AutoMapper使用学习笔记</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/post/oldblog/Dapper框架.html" class="sidebar-link">Dapper框架</a></li><li><a href="/post/oldblog/MongoDB-CSharp-Driver-快速入门指南.html" class="active sidebar-link">MongoDB C# Driver 快速入门指南</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/post/oldblog/NLog教程.html" class="sidebar-link">NLog教程</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/post/oldblog/微服务-Consul服务治理发现.html" class="sidebar-link">微服务 - Consul服务治理发现</a></li><li><a href="/post/oldblog/微服务-JWT.html" class="sidebar-link">微服务 - JWT 算法</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/post/oldblog/微服务-Ocelot API 网关.html" class="sidebar-link">微服务 - Ocelot API 网关</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/post/oldblog/微服务-Polly熔断降级.html" class="sidebar-link">微服务 - Polly熔断降级</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/post/oldblog/Redis-CSharp-Driver.html" class="sidebar-link">Redis C# Driver - StackExchange.Redis</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p><a href="http://www.jianshu.com/p/0221b85528bf" target="_blank" rel="noopener noreferrer">如何在 Windows 上安装 MongoDB<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="http://www.jianshu.com/p/7ee3f98ed4c8" target="_blank" rel="noopener noreferrer">MongoDB C# Driver 管理快速入门指南<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>这是MongoDB driver的第一部分。在这一部分，你可以看到如何去执行一些数据库的基本CRUD（C-创建，R-读取，U-更新，D-删除）操作。</p> <p><img src="http://upload-images.jianshu.io/upload_images/1366611-698a27df28727b62.jpeg?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p> <h3 id="连接"><a href="#连接" class="header-anchor">#</a> 连接</h3> <p>以下展示了三种连接到MongoDB远程服务器和本地服务器的方式 :</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token comment">// 连接到单实例MongoDB服务</span>
<span class="token comment">// 这种连接方式不会自动检测连接的节点是主节点还是复制集的成员节点</span>
<span class="token keyword">var</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MongoClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 或者使用string连接本地服务器,localhost=127.0.0.1,连接到单实例</span>
<span class="token keyword">var</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MongoClient</span><span class="token punctuation">(</span><span class="token string">&quot;mongodb://localhost:27017&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 连接到复制集（多节点）</span>
<span class="token keyword">var</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MongoClient</span><span class="token punctuation">(</span><span class="token string">&quot;mongodb://localhost:27017,localhost:27018,localhost:27019&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>客户端实例现在可以拥有连接到连接字符串中指定的服务器或服务器的连接池。</p> <h4 id="mongoclient"><a href="#mongoclient" class="header-anchor">#</a> MongoClient</h4> <p><code>MongoClient</code> 实例实际上表示一个连接数据库的连接池；</p> <p>你仅仅只需要一个<code>MongoClient</code> 类实例，即使在多线程情况下；</p> <blockquote><p>标注：
实际上，你只需要为给定的集群创建一个MongoClient实例，并在应用程序中使用它。但是，如果连接字符串是相同的，那么创建多个MongoClient将仍然共享相同的连接池。</p></blockquote> <h4 id="get-a-database"><a href="#get-a-database" class="header-anchor">#</a> Get a Database</h4> <p>获取一个数据库实例，列举数据库的名称可以通过<code>client</code>中的<code>GetDatabase</code>方法，在数据库存在的情况下，该方式都是可行的。它将在首次被调用时创建。</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">var</span> database <span class="token operator">=</span> client<span class="token punctuation">.</span><span class="token function">GetDatabase</span><span class="token punctuation">(</span><span class="token string">&quot;foo&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>现在，<code>database</code>变量保存了对数据库“foo”的引用.</p> <h4 id="get-a-collection"><a href="#get-a-collection" class="header-anchor">#</a> Get a Collection</h4> <p>获取一个集合实例，列举集合的名称可以通过<code>database</code>中<a href="http://mongodb.github.io/mongo-csharp-driver/2.4/apidocs/html/M_MongoDB_Driver_IMongoDatabase_GetCollection__1.htm" target="_blank" rel="noopener noreferrer"><code>GetCollection&lt;TDocument&gt;</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>.在集合存在的情况下，它将在首次被调用时创建。</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">var</span> collection <span class="token operator">=</span> database<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">GetCollection</span><span class="token punctuation">&lt;</span><span class="token class-name">BsonDocument</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token string">&quot;bar&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>现在，<code>collection</code>变量保存了对数据库“foo”下“bar”集合的引用.</p> <blockquote><p>标注：
泛型参数TDocument表示集合中存在的模式，使用一个BsonDocument来表示没有预定的模式。</p></blockquote> <h4 id="insert-a-document"><a href="#insert-a-document" class="header-anchor">#</a> Insert a Document</h4> <p>一旦你拥有了<code>collection</code>实例，你就可以插入一个文档到集合中。例如，考虑下面的JSON文档，它是一个包含了一个字段信息的嵌入式文档。</p> <div class="language-json extra-class"><pre class="language-json"><code><span class="token punctuation">{</span>
     <span class="token property">&quot;name&quot;</span><span class="token operator">:</span> <span class="token string">&quot;MongoDB&quot;</span><span class="token punctuation">,</span>
     <span class="token property">&quot;type&quot;</span><span class="token operator">:</span> <span class="token string">&quot;database&quot;</span><span class="token punctuation">,</span>
     <span class="token property">&quot;count&quot;</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
     <span class="token property">&quot;info&quot;</span><span class="token operator">:</span> <span class="token punctuation">{</span>
         x<span class="token operator">:</span> <span class="token number">203</span><span class="token punctuation">,</span>
         y<span class="token operator">:</span> <span class="token number">102</span>
     <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>你可以使用.NET driver中的BsonDocument类创建这个文档，方式如下：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">var</span> document <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">BsonDocument</span>
<span class="token punctuation">{</span>
    <span class="token punctuation">{</span> <span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;MongoDB&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token string">&quot;type&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;Database&quot;</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token string">&quot;count&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token punctuation">{</span> <span class="token string">&quot;info&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">BsonDocument</span>
        <span class="token punctuation">{</span>
            <span class="token punctuation">{</span> <span class="token string">&quot;x&quot;</span><span class="token punctuation">,</span> <span class="token number">203</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
            <span class="token punctuation">{</span> <span class="token string">&quot;y&quot;</span><span class="token punctuation">,</span> <span class="token number">102</span> <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>把这个文档插入到集合中，可以是使用<code>InsertOne</code>或者<code>InsertOneAsync</code>方法</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>collection<span class="token punctuation">.</span><span class="token function">InsertOne</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//同步</span>
<span class="token keyword">await</span> collection<span class="token punctuation">.</span><span class="token function">InsertOneAsycn</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//异步</span>
</code></pre></div><div class="language-csharp extra-class"><pre class="language-csharp"><code>标注：
<span class="token punctuation">.</span><span class="token class-name">NET</span> driver 当前已全部支持异步操作。关于更多的<span class="token keyword">async</span>和<span class="token keyword">await</span>的信息，参见<span class="token class-name">MSDN</span> documentation
https<span class="token punctuation">:</span><span class="token operator">/</span><span class="token operator">/</span>msdn<span class="token punctuation">.</span>microsoft<span class="token punctuation">.</span>com<span class="token operator">/</span>en<span class="token operator">-</span>us<span class="token operator">/</span>library<span class="token operator">/</span>hh191443<span class="token punctuation">.</span>aspx
驱动中所有的API都已经同时支持同步和异步<span class="token punctuation">.</span>
</code></pre></div><h4 id="insert-multiple-documents"><a href="#insert-multiple-documents" class="header-anchor">#</a> Insert Multiple Documents</h4> <p>插入多条数据到数据库，可以使用<code>InsertMany</code>或者<code>InsertManyAsync</code>两种方式.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token comment">// 生成 100 个counter从0~99递增的文档</span>
<span class="token keyword">var</span> documents <span class="token operator">=</span> Enumerable<span class="token punctuation">.</span><span class="token function">Range</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>i <span class="token operator">=&gt;</span> <span class="token keyword">new</span> <span class="token class-name">BsonDocument</span><span class="token punctuation">(</span><span class="token string">&quot;counter&quot;</span><span class="token punctuation">,</span> i<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>插入数据</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>collection<span class="token punctuation">.</span><span class="token function">InsertManh</span><span class="token punctuation">(</span>documnets<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> collection<span class="token punctuation">.</span><span class="token function">InsertManyAsycn</span><span class="token punctuation">(</span>documents<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="counting-documents"><a href="#counting-documents" class="header-anchor">#</a> Counting Documents</h4> <p>现在，我们插入了101个文档到数据库里面（100在循环中，首次插入1）,我们可以核查这些数据，如果我们使用<code>Count</code>或者<code>CountAsycn</code>方法. 下面的代码应该可以使得<code>count</code>的值为101.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">var</span> count <span class="token operator">=</span> collection<span class="token punctuation">.</span><span class="token function">Count</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BsonDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
or
<span class="token keyword">var</span> count <span class="token operator">=</span> <span class="token keyword">await</span> collection<span class="token punctuation">.</span><span class="token function">CountAsync</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BsonDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><blockquote><p>标注：
空的BsonDocument参数是一个过滤器。在这里，指的是要计算所有的文档.</p></blockquote> <h4 id="query-the-collection"><a href="#query-the-collection" class="header-anchor">#</a> Query the Collection</h4> <p>使用<code>Find</code>方法去集合中查询. 该方法会返回一个<a href="http://mongodb.github.io/mongo-csharp-driver/2.4/apidocs/html/T_MongoDB_Driver_IFindFluent_2.htm" target="_blank" rel="noopener noreferrer"><code>IFindFluent&lt;TDocument, TProjection&gt;</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 实例，它提供一个接口链接find操作设置.</p> <h5 id="find-the-first-document-in-a-collection"><a href="#find-the-first-document-in-a-collection" class="header-anchor">#</a> Find the First Document in a Collection</h5> <p>调用<a href="http://mongodb.github.io/mongo-csharp-driver/2.4/apidocs/html/M_MongoDB_Driver_IFindFluentExtensions_FirstOrDefault__2.htm" target="_blank" rel="noopener noreferrer">FirstOrDefault<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 或者<a href="http://mongodb.github.io/mongo-csharp-driver/2.4/apidocs/html/M_MongoDB_Driver_IFindFluentExtensions_FirstOrDefaultAsync__2.htm" target="_blank" rel="noopener noreferrer">FirstOrDefaultAsync<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 方法，可以获取集合的第一个文档.<code>FirstOrDefault</code>返回第一个文档或者null. 当你只需要一个匹配的文档或只对第一个文档感兴趣时，该方法非常有用.</p> <p>下面的例子将会打印出再集合中查询出来的第一个文档：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">var</span> document <span class="token operator">=</span> collection<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BsonDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FirstOrDefault</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Consloe<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">var</span> document <span class="token operator">=</span> <span class="token keyword">await</span> collection<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BsonDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FirstOrDefaultAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>该例子将会打印出以下内容:</p> <div class="language- extra-class"><pre class="language-text"><code>{ 
    &quot;_id&quot;: ObjectId(&quot;5940f2b98198abd6a5eea7b1&quot;) },
    &quot;name&quot;: &quot;MongoDB&quot;, 
    &quot;type&quot;: &quot;database&quot;, 
    &quot;count&quot;: 1,
    &quot;info&quot;: { &quot;x&quot; : 203, &quot;y&quot; : 102 } 
}
</code></pre></div><blockquote><p>元素 “id” 为 <em>MongoDB</em> 数据库自动添加到文档中，这是打印出来的内容与插入的内容不一致的原因。MongoDB数据库内部保留所有以 <code>“_”</code>  和  <code>“$”</code> 开头的字段名称.</p></blockquote> <h5 id="find-all-documents-in-a-collection"><a href="#find-all-documents-in-a-collection" class="header-anchor">#</a> Find All Documents in a Collection</h5> <p>使用<code>ToList</code>或者<code>ToListAsycn</code>方法可以检索到集合中的所有文档，当需要返回的文档比较少量时，该方法非常有用.</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">var</span> documents <span class="token operator">=</span> collection<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BsonDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">var</span> documents <span class="token operator">=</span> <span class="token keyword">await</span> collection<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BsonDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToListAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>如果返回的文档数量比预期的大，可以使用通过迭代的方式进行处理。<code>ForEachAsync</code>将会为每个返回的文档调用一个回调。</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">await</span> collection<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BsonDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ForEachAsync</span><span class="token punctuation">(</span>d <span class="token operator">=&gt;</span> Console<span class="token punctuation">.</span><span class="token function">WriteLined</span><span class="token punctuation">(</span>d<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>如果使用的是同步的API，则要使用C#中的<code>ToEnumerable</code>抽象方法去迭代每个文档：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">var</span> cursor <span class="token operator">=</span> collection<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BsonDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToCursor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token keyword">var</span> document <span class="token keyword">in</span> cursor<span class="token punctuation">.</span><span class="token function">ToEnumerable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">;</span>   
<span class="token punctuation">}</span>
</code></pre></div><p>上面的例子将会打印出相同的信息。更多的信息参见<a href="http://mongodb.github.io/mongo-csharp-driver/2.4/reference/driver/crud/reading/#finding-documents" target="_blank" rel="noopener noreferrer">reference documention<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <h5 id="get-a-single-document-with-a-filter"><a href="#get-a-single-document-with-a-filter" class="header-anchor">#</a> Get a Single Document With a Filter</h5> <p>在一个集合中，我们可以创建一个筛选器传递给<code>Find</code>方法去获取一个文档的子集。例如，如果我们想查找“i”字段的值为71的文档，我们可以使用如下的方式:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">var</span> filter <span class="token operator">=</span> Builders<span class="token operator">&lt;</span>BsonDocument<span class="token operator">&gt;</span><span class="token punctuation">.</span>Filter<span class="token punctuation">.</span><span class="token function">Eq</span><span class="token punctuation">(</span><span class="token string">&quot;i&quot;</span><span class="token punctuation">,</span> <span class="token number">71</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">var</span> document <span class="token operator">=</span> collection<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">var</span> document <span class="token operator">=</span> <span class="token keyword">await</span> collection<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FirstAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>以上应该仅打印出一个文档:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token punctuation">{</span> <span class="token string">&quot;_id&quot;</span> <span class="token punctuation">:</span> <span class="token function">ObjectId</span><span class="token punctuation">(</span><span class="token string">&quot;5515836e58c7b4fbc756320b&quot;</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">&quot;i&quot;</span> <span class="token punctuation">:</span> <span class="token number">71</span> <span class="token punctuation">}</span>
</code></pre></div><blockquote><p>标注：</p> <p>使用 <code>Filter</code>，<code>Sort</code> 和 <code>Projection</code> 以简单和简洁的方式创建一个查询.</p></blockquote> <h5 id="get-a-set-of-documents-with-a-filter"><a href="#get-a-set-of-documents-with-a-filter" class="header-anchor">#</a> Get a Set of Documents With a Filter</h5> <p>我们也可以从集合中获取一组文档。例如，如果我们获取所有符合 i &gt; 50 条件的文档，可以使用如下的方式:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">var</span> filter <span class="token operator">=</span> Builders<span class="token operator">&lt;</span>BsonDocument<span class="token operator">&gt;</span><span class="token punctuation">.</span>Filter<span class="token punctuation">.</span><span class="token function">Gt</span><span class="token punctuation">(</span><span class="token string">&quot;i&quot;</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Gt表示大于</span>
</code></pre></div><div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">var</span> cursor <span class="token operator">=</span> collection<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToCursor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token keyword">var</span> document <span class="token keyword">in</span> cursor<span class="token punctuation">.</span><span class="token function">ToEnumerable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">;</span>   
<span class="token punctuation">}</span>
</code></pre></div><div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">await</span> collection<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ForEachAsync</span><span class="token punctuation">(</span>document <span class="token operator">=&gt;</span> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>还可以限定一个范围查询，例如 50 &lt; i &lt;= 100;</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">var</span> filterBuilder <span class="token operator">=</span> Builders<span class="token operator">&lt;</span>BsonDocument<span class="token operator">&gt;</span><span class="token punctuation">.</span>Filter<span class="token punctuation">;</span>
<span class="token keyword">var</span> filter <span class="token operator">=</span> filterBuilder<span class="token punctuation">.</span><span class="token function">Gt</span><span class="token punctuation">(</span><span class="token string">&quot;i&quot;</span><span class="token punctuation">,</span> <span class="token number">50</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span> filterBuilder<span class="token punctuation">.</span><span class="token function">Lte</span><span class="token punctuation">(</span><span class="token string">&quot;i&quot;</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//Lt表示小于，Lte表示小于等于</span>
</code></pre></div><div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">var</span> cursor <span class="token operator">=</span> collection<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ToCursor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token keyword">var</span> document <span class="token keyword">in</span> cursor<span class="token punctuation">.</span><span class="token function">ToEnumerable</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">;</span>   
<span class="token punctuation">}</span>
</code></pre></div><div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">await</span> collection<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ForEachAsync</span><span class="token punctuation">(</span>document <span class="token operator">=&gt;</span> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>document<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h5 id="sorting-documents"><a href="#sorting-documents" class="header-anchor">#</a> Sorting Documents</h5> <p>我们可以通过调用 <code>Sort</code> 方法来创建一个排序匹配查询。在现有的 <code>filter</code> 构造方法下，我们可以使用 <code>Descending</code> 建立一个降序构造器来排序我们的文档：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">var</span> filter <span class="token operator">=</span> Builders<span class="token operator">&lt;</span>BsonDocument<span class="token operator">&gt;</span><span class="token punctuation">.</span>Filter<span class="token punctuation">.</span><span class="token function">Exists</span><span class="token punctuation">(</span><span class="token string">&quot;i&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> sort <span class="token operator">=</span> Builders<span class="token operator">&lt;</span>BsonDocument<span class="token operator">&gt;</span><span class="token punctuation">.</span>Sort<span class="token punctuation">.</span><span class="token function">Descending</span><span class="token punctuation">(</span><span class="token string">&quot;i&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">var</span> document <span class="token operator">=</span> collection<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Sort</span><span class="token punctuation">(</span>sort<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">var</span> document <span class="token operator">=</span> <span class="token keyword">await</span> collection<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Sort</span><span class="token punctuation">(</span>sort<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FirstAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h5 id="projecting-fields（映射字段）"><a href="#projecting-fields（映射字段）" class="header-anchor">#</a> Projecting Fields（映射字段）</h5> <p>很多时候，我们不需要文档中包含的所有字段，<code>Projection</code> 构造器可以在一个查询操作中构造映射字段。下面的例子中，我们排除了“_id”字段，并且输出第一个匹配的文档：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">var</span> projection <span class="token operator">=</span> Builders<span class="token operator">&lt;</span>BsonDocument<span class="token operator">&gt;</span><span class="token punctuation">.</span>Projection<span class="token punctuation">.</span><span class="token function">Exclude</span><span class="token punctuation">(</span><span class="token string">&quot;_id&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">var</span> document <span class="token operator">=</span> collection<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BsonDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Project</span><span class="token punctuation">(</span>projection<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">First</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">var</span> document <span class="token operator">=</span> <span class="token keyword">await</span> collection<span class="token punctuation">.</span><span class="token function">Find</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BsonDocument</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Project</span><span class="token punctuation">(</span>projection<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">FirstAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h5 id="updating-documents"><a href="#updating-documents" class="header-anchor">#</a> Updating Documents</h5> <p>MongoDB 支持多种<a href="http://docs.mongodb.org/manual/reference/operator/update-field/" target="_blank" rel="noopener noreferrer">更新操作<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>方式</p> <p>更新最多一个文档（如果没有匹配筛选器，可能为零个文档），使用<a href="http://mongodb.github.io/mongo-csharp-driver/2.4/apidocs/html/M_MongoDB_Driver_IMongoCollection_1_UpdateOne.htm" target="_blank" rel="noopener noreferrer"><code>UpdateOne</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>或者<a href="http://mongodb.github.io/mongo-csharp-driver/2.4/apidocs/html/M_MongoDB_Driver_IMongoCollection_1_UpdateOneAsync.htm" target="_blank" rel="noopener noreferrer"><code>UpdateOneAsync</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>去指定筛选器并更新匹配的文档。下面，我们更新筛选器为 i == 10 匹配的第一个文档，并将该文档 i 的值更新为110:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">var</span> filter <span class="token operator">=</span> Builders<span class="token operator">&lt;</span>BsonDocument<span class="token operator">&gt;</span><span class="token punctuation">.</span>Filter<span class="token punctuation">.</span><span class="token function">Eq</span><span class="token punctuation">(</span><span class="token string">&quot;i&quot;</span><span class="token punctuation">,</span> <span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> update <span class="token operator">=</span> Builders<span class="token operator">&lt;</span>BsonDocument<span class="token operator">&gt;</span><span class="token punctuation">.</span>Update<span class="token punctuation">.</span><span class="token function">Set</span><span class="token punctuation">(</span><span class="token string">&quot;i&quot;</span><span class="token punctuation">,</span> <span class="token number">110</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-csharp extra-class"><pre class="language-csharp"><code>collection<span class="token punctuation">.</span><span class="token function">UpdateOne</span><span class="token punctuation">(</span>filter<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">await</span> collection<span class="token punctuation">.</span><span class="token function">UpdateOneAsync</span><span class="token punctuation">(</span>filter<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>更新筛选器匹配的所有文档，使用<a href="http://mongodb.github.io/mongo-csharp-driver/2.4/apidocs/html/M_MongoDB_Driver_IMongoCollection_1_UpdateMany.htm" target="_blank" rel="noopener noreferrer"><code>UpdateMany</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>或者<a href="http://mongodb.github.io/mongo-csharp-driver/2.4/apidocs/html/M_MongoDB_Driver_IMongoCollection_1_UpdateManyAsync.htm" target="_blank" rel="noopener noreferrer"><code>UpdateManyAsync</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>方法。下面例子，将把所有 i &lt; 100 匹配的文档中 i 的值增加 100。</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">var</span> filter <span class="token operator">=</span> Builders<span class="token operator">&lt;</span>BsonDocument<span class="token operator">&gt;</span><span class="token punctuation">.</span>Filter<span class="token punctuation">.</span><span class="token function">Lt</span><span class="token punctuation">(</span><span class="token string">&quot;i&quot;</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> update <span class="token operator">=</span> Builders<span class="token operator">&lt;</span>BsonDocument<span class="token operator">&gt;</span><span class="token punctuation">.</span>Update<span class="token punctuation">.</span><span class="token function">Inc</span><span class="token punctuation">(</span><span class="token string">&quot;i&quot;</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Inc操作符表示：给i字段增加某个大小的值</span>
</code></pre></div><div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">var</span> result <span class="token operator">=</span> collection<span class="token punctuation">.</span><span class="token function">UpdateOne</span><span class="token punctuation">(</span>filter<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>IsModifiedCountAvailable<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>ModifiedCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token keyword">await</span> collection<span class="token punctuation">.</span><span class="token function">UpdateOneAsync</span><span class="token punctuation">(</span>filter<span class="token punctuation">,</span> update<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>result<span class="token punctuation">.</span>IsModifiedCountAvailable<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>ModifiedCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>更新方法返回的结果为<a href="http://mongodb.github.io/mongo-csharp-driver/2.4/apidocs/html/T_MongoDB_Driver_UpdateResult.htm" target="_blank" rel="noopener noreferrer"><code>UpdateResult</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，它提供关于该操作的信息，包括更新后修改的文档的数量。</p> <blockquote><p>标注:</p> <p>根据MongoDB数据库的版本，某些特性可能无法使用。在这些情况下，我们已经尝试了检查是否有能力检查它们的可用性。</p></blockquote> <h5 id="deleting-documents"><a href="#deleting-documents" class="header-anchor">#</a> Deleting Documents</h5> <p>删除最多一个文档（如果没有匹配筛选器，可能为零个文档），使用  <a href="http://mongodb.github.io/mongo-csharp-driver/2.4/apidocs/html/M_MongoDB_Driver_IMongoCollection_1_DeleteOne.htm" target="_blank" rel="noopener noreferrer"><code>DeleteOne</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 或者  <a href="http://mongodb.github.io/mongo-csharp-driver/2.4/apidocs/html/M_MongoDB_Driver_IMongoCollection_1_DeleteOneAsync.htm" target="_blank" rel="noopener noreferrer"><code>DeleteOneAsync</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>方法：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">var</span> filter <span class="token operator">=</span> Builders<span class="token operator">&lt;</span>BsonDocument<span class="token operator">&gt;</span><span class="token punctuation">.</span>Filter<span class="token punctuation">.</span><span class="token function">Eq</span><span class="token punctuation">(</span><span class="token string">&quot;i&quot;</span><span class="token punctuation">,</span> <span class="token number">110</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-csharp extra-class"><pre class="language-csharp"><code>collection<span class="token punctuation">.</span><span class="token function">DeleteOne</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">await</span> collection<span class="token punctuation">.</span><span class="token function">DeleteOneAsync</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>删除筛选器匹配的所有文档，使用<a href="http://mongodb.github.io/mongo-csharp-driver/2.4/apidocs/html/M_MongoDB_Driver_IMongoCollection_1_DeleteMany.htm" target="_blank" rel="noopener noreferrer"><code>DeleteMany</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 或者 <a href="http://mongodb.github.io/mongo-csharp-driver/2.4/apidocs/html/M_MongoDB_Driver_IMongoCollection_1_DeleteManyAsync.htm" target="_blank" rel="noopener noreferrer"><code>DeleteManyAsync</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 方法。下面是删除所有 i &gt;= 100 匹配的文档：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">var</span> filter <span class="token operator">=</span> Builders<span class="token operator">&lt;</span>BsonDocument<span class="token operator">&gt;</span><span class="token punctuation">.</span>Filter<span class="token punctuation">.</span><span class="token function">Gte</span><span class="token punctuation">(</span><span class="token string">&quot;i&quot;</span><span class="token punctuation">,</span> <span class="token number">100</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// Gte表示大于等于</span>
</code></pre></div><div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">var</span> result <span class="token operator">=</span> collection<span class="token punctuation">.</span><span class="token function">DeleteMany</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span><span class="token punctuation">;</span>

Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>DeletedCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token keyword">await</span> collection<span class="token punctuation">.</span><span class="token function">DeleteManyAsync</span><span class="token punctuation">(</span>filter<span class="token punctuation">)</span><span class="token punctuation">;</span>

Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>DeletedCount<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>删除方法返回的结果为<a href="http://mongodb.github.io/mongo-csharp-driver/2.4/apidocs/html/T_MongoDB_Driver_DeleteResult.htm" target="_blank" rel="noopener noreferrer"><code>DeleteResult</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> ，它提供关于该操作的信息，包括删除的文档数量。</p> <h5 id="bulk-writes-（批量操作）"><a href="#bulk-writes-（批量操作）" class="header-anchor">#</a> Bulk Writes （批量操作）</h5> <p>Bulk 操作有两种类型：</p> <blockquote><ol><li>有序Bulk操作</li></ol> <p>以有序的方式执行所有的操作，并且在首次遇到异常时抛出异常。</p> <ol start="2"><li>无序Bulk操作</li></ol> <p>执行所有的操作，并记录操作过程中的全部异常。无序的批量操作不能保证执行的顺序。</p></blockquote> <p>让我们看一看下面的两个关于有序和无序的操作例子：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">var</span> models <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">WriteModel</span><span class="token operator">&lt;</span>BsonDocument<span class="token operator">&gt;</span><span class="token punctuation">[</span><span class="token punctuation">]</span> 
<span class="token punctuation">{</span>
    <span class="token keyword">new</span> <span class="token generic-method"><span class="token function">InsertOneModel</span><span class="token punctuation">&lt;</span><span class="token class-name">BsonDocument</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BsonDocument</span><span class="token punctuation">(</span><span class="token string">&quot;_id&quot;</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token generic-method"><span class="token function">InsertOneModel</span><span class="token punctuation">&lt;</span><span class="token class-name">BsonDocument</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BsonDocument</span><span class="token punctuation">(</span><span class="token string">&quot;_id&quot;</span><span class="token punctuation">,</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token generic-method"><span class="token function">InsertOneModel</span><span class="token punctuation">&lt;</span><span class="token class-name">BsonDocument</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BsonDocument</span><span class="token punctuation">(</span><span class="token string">&quot;_id&quot;</span><span class="token punctuation">,</span> <span class="token number">6</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token generic-method"><span class="token function">UpdateOneModel</span><span class="token punctuation">&lt;</span><span class="token class-name">BsonDocument</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
        <span class="token keyword">new</span> <span class="token class-name">BsonDocument</span><span class="token punctuation">(</span><span class="token string">&quot;_id&quot;</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
        <span class="token keyword">new</span> <span class="token class-name">BsonDocument</span><span class="token punctuation">(</span><span class="token string">&quot;$set&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">BsonDocument</span><span class="token punctuation">(</span><span class="token string">&quot;x&quot;</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token generic-method"><span class="token function">DeleteOneModel</span><span class="token punctuation">&lt;</span><span class="token class-name">BsonDocument</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">BsonDocument</span><span class="token punctuation">(</span><span class="token string">&quot;_id&quot;</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token keyword">new</span> <span class="token generic-method"><span class="token function">ReplaceOneModel</span><span class="token punctuation">&lt;</span><span class="token class-name">BsonDocument</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>
        <span class="token keyword">new</span> <span class="token class-name">BsonDocument</span><span class="token punctuation">(</span><span class="token string">&quot;_id&quot;</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">,</span> 
        <span class="token keyword">new</span> <span class="token class-name">BsonDocument</span><span class="token punctuation">(</span><span class="token string">&quot;_id&quot;</span><span class="token punctuation">,</span> <span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token string">&quot;x&quot;</span><span class="token punctuation">,</span> <span class="token number">4</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token comment">// 1. 有序的批量操作 - 保证操作的顺序</span>
collection<span class="token punctuation">.</span><span class="token function">BulkWrite</span><span class="token punctuation">(</span>models<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 2. 无序的批量操作 - 无法保证操作的顺序</span>
collection<span class="token punctuation">.</span><span class="token function">BulkWrite</span><span class="token punctuation">(</span>models<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">BulkWriteOptions</span> <span class="token punctuation">{</span> IsOrdered <span class="token operator">=</span> <span class="token keyword">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>异步</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token comment">// 1. 有序的批量操作 - 保证操作的顺序</span>
<span class="token keyword">await</span> collection<span class="token punctuation">.</span><span class="token function">BulkWriteAsync</span><span class="token punctuation">(</span>models<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 2. 无序的批量操作 - 无法保证操作的顺序</span>
<span class="token keyword">await</span> collection<span class="token punctuation">.</span><span class="token function">BulkWriteAsync</span><span class="token punctuation">(</span>models<span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">BulkWriteOptions</span> <span class="token punctuation">{</span> IsOrdered <span class="token operator">=</span> <span class="token keyword">false</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">重要:</p> <p>批量操作功能在MongoDB数据库版本为2.6及之前的版本不被推荐使用，在性能上有较大的影响。</p></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time"> 2019年 12月 28日 15:53:50</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/post/oldblog/Dapper框架.html" class="prev">Dapper框架</a></span> <span class="next"><a href="/post/oldblog/NLog教程.html">NLog教程</a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.fa3e3824.js" defer></script><script src="/assets/js/2.230529bd.js" defer></script><script src="/assets/js/29.eb08d370.js" defer></script>
  </body>
</html>
