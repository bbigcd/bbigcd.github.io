<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>微服务 - Consul服务治理发现 | bbigcd</title>
    <meta name="description" content="Make more time">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.0cbbf90a.css" as="style"><link rel="preload" href="/assets/js/app.fa3e3824.js" as="script"><link rel="preload" href="/assets/js/2.230529bd.js" as="script"><link rel="preload" href="/assets/js/32.daf1012d.js" as="script"><link rel="prefetch" href="/assets/js/10.c93fe082.js"><link rel="prefetch" href="/assets/js/11.4bf3ae7f.js"><link rel="prefetch" href="/assets/js/12.01c45e0e.js"><link rel="prefetch" href="/assets/js/13.d9d858d9.js"><link rel="prefetch" href="/assets/js/14.00d956f4.js"><link rel="prefetch" href="/assets/js/15.679c6742.js"><link rel="prefetch" href="/assets/js/16.abbcd59e.js"><link rel="prefetch" href="/assets/js/17.1f5585d5.js"><link rel="prefetch" href="/assets/js/18.149d6c4f.js"><link rel="prefetch" href="/assets/js/19.4dd5acbe.js"><link rel="prefetch" href="/assets/js/20.874851b7.js"><link rel="prefetch" href="/assets/js/21.e8fab656.js"><link rel="prefetch" href="/assets/js/22.74ef4341.js"><link rel="prefetch" href="/assets/js/23.0815466b.js"><link rel="prefetch" href="/assets/js/24.3923d245.js"><link rel="prefetch" href="/assets/js/25.dd992728.js"><link rel="prefetch" href="/assets/js/26.f9a0d7a7.js"><link rel="prefetch" href="/assets/js/27.54f139b7.js"><link rel="prefetch" href="/assets/js/28.070cfa63.js"><link rel="prefetch" href="/assets/js/29.eb08d370.js"><link rel="prefetch" href="/assets/js/3.447720c6.js"><link rel="prefetch" href="/assets/js/30.e66848e4.js"><link rel="prefetch" href="/assets/js/31.0438d4db.js"><link rel="prefetch" href="/assets/js/33.9f79b5b3.js"><link rel="prefetch" href="/assets/js/34.086724a3.js"><link rel="prefetch" href="/assets/js/35.90c07cc0.js"><link rel="prefetch" href="/assets/js/36.056ad52c.js"><link rel="prefetch" href="/assets/js/4.0f091beb.js"><link rel="prefetch" href="/assets/js/5.4c5d2735.js"><link rel="prefetch" href="/assets/js/6.a4af8558.js"><link rel="prefetch" href="/assets/js/7.8feeb04b.js"><link rel="prefetch" href="/assets/js/8.1af69973.js"><link rel="prefetch" href="/assets/js/9.e612d3ea.js">
    <link rel="stylesheet" href="/assets/css/0.styles.0cbbf90a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">bbigcd</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/netcore/" class="nav-link">NetCore</a></div><div class="nav-item"><a href="/csharp/" class="nav-link">CSharp</a></div><div class="nav-item"><a href="/post/" class="nav-link router-link-active">Other</a></div><div class="nav-item"><a href="/about-me/" class="nav-link">AboutMe</a></div><div class="nav-item"><a href="https://www.github.com/bbigcd" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/netcore/" class="nav-link">NetCore</a></div><div class="nav-item"><a href="/csharp/" class="nav-link">CSharp</a></div><div class="nav-item"><a href="/post/" class="nav-link router-link-active">Other</a></div><div class="nav-item"><a href="/about-me/" class="nav-link">AboutMe</a></div><div class="nav-item"><a href="https://www.github.com/bbigcd" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>旧博客内容</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/post/oldblog/ASP.NET Web Api 2 Http 消息生命周期.html" class="sidebar-link">ASP.NET Web Api 2 Http 消息生命周期</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/post/oldblog/ASP.NET中关于Async和Await的概述.html" class="sidebar-link">ASP.NET 中关于Async和Await的概述【译】</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/post/oldblog/AutoMapper使用学习笔记.html" class="sidebar-link">AutoMapper使用学习笔记</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/post/oldblog/Dapper框架.html" class="sidebar-link">Dapper框架</a></li><li><a href="/post/oldblog/MongoDB-CSharp-Driver-快速入门指南.html" class="sidebar-link">MongoDB C# Driver 快速入门指南</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/post/oldblog/NLog教程.html" class="sidebar-link">NLog教程</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/post/oldblog/微服务-Consul服务治理发现.html" class="active sidebar-link">微服务 - Consul服务治理发现</a></li><li><a href="/post/oldblog/微服务-JWT.html" class="sidebar-link">微服务 - JWT 算法</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/post/oldblog/微服务-Ocelot API 网关.html" class="sidebar-link">微服务 - Ocelot API 网关</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/post/oldblog/微服务-Polly熔断降级.html" class="sidebar-link">微服务 - Polly熔断降级</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/post/oldblog/Redis-CSharp-Driver.html" class="sidebar-link">Redis C# Driver - StackExchange.Redis</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><p>在微服务中，Consul是注册中心，服务提供者、服务消费者等都要注册到Consul中，这样就可以实现服务提供者与服务消费者的隔离。</p> <p>除了Consul之外，还有Eureka、Zookeeper等类似软件.</p> <p>用DNS举例来理解Consul的作用：</p> <p><img src="tu" alt=""></p> <h4 id="consul-服务器安装"><a href="#consul-服务器安装" class="header-anchor">#</a> Consul 服务器安装</h4> <p>consul 下载地址 https://www.consul.io/</p> <p>运行 <code>consul.exe agent -dev</code></p> <p>这是开发环境测试，生产环境要建集群，要至少一台 Server，多台 Agent。</p> <p>consul 的监控页面 http://127.0.0.1:8500/</p> <h4 id="net-core-连接-consul"><a href="#net-core-连接-consul" class="header-anchor">#</a> .Net Core 连接 Consul</h4> <p>使用 Nuget 包管理工具</p> <p><code>Install-Package Consul</code></p> <h4 id="rest-服务的准备"><a href="#rest-服务的准备" class="header-anchor">#</a> Rest 服务的准备</h4> <p>先使用使用默认生成的 ValuesController 做测试
再提供一个 HealthController.cs</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token punctuation">[</span><span class="token class-name">Route</span><span class="token punctuation">(</span><span class="token string">&quot;api/[controller]&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HealthController</span> <span class="token punctuation">:</span> <span class="token class-name">Controller</span>
<span class="token punctuation">{</span>
	<span class="token punctuation">[</span><span class="token class-name">HttpGet</span><span class="token punctuation">]</span>
	<span class="token keyword">public</span> <span class="token class-name">IActionResult</span> <span class="token function">Get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token function">Ok</span><span class="token punctuation">(</span><span class="token string">&quot;ok&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>服务器从命令行中读取 ip 和端口。</p> <h4 id="让rest服务注册到-consul-中"><a href="#让rest服务注册到-consul-中" class="header-anchor">#</a> 让Rest服务注册到 Consul 中</h4> <p>在 Startup.cs</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">Configure</span><span class="token punctuation">(</span><span class="token class-name">IApplicationBuilder</span> app<span class="token punctuation">,</span> <span class="token class-name">IHostingEnvironment</span> env<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">//......</span>
    app<span class="token punctuation">.</span><span class="token function">UseMvc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//部署到不同服务器的时候不能写成 127.0.0.1 或者 0.0.0.0</span>
  	<span class="token comment">//因为这是让服务消费者调用的地址</span>
    <span class="token class-name">String</span> ip <span class="token operator">=</span> Configuration<span class="token punctuation">[</span><span class="token string">&quot;ip&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> port <span class="token operator">=</span> <span class="token keyword">int</span><span class="token punctuation">.</span><span class="token function">Parse</span><span class="token punctuation">(</span>Configuration<span class="token punctuation">[</span><span class="token string">&quot;port&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> client <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ConsulClient</span><span class="token punctuation">(</span>ConfigurationOverview<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> result <span class="token operator">=</span> client<span class="token punctuation">.</span>Agent<span class="token punctuation">.</span><span class="token function">ServiceRegister</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">AgentServiceRegistration</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        ID <span class="token operator">=</span> <span class="token string">&quot;WebApplication4&quot;</span> <span class="token operator">+</span> Guid<span class="token punctuation">.</span><span class="token function">NewGuid</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        Name <span class="token operator">=</span> <span class="token string">&quot;WebApplication4&quot;</span><span class="token punctuation">,</span>
        Address <span class="token operator">=</span> ip<span class="token punctuation">,</span>
        Port <span class="token operator">=</span> port<span class="token punctuation">,</span>
        Check <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">AgentServiceCheck</span>
        <span class="token punctuation">{</span>
            <span class="token comment">//服务启动多久后注册</span>
            DeregisterCriticalServiceAfter <span class="token operator">=</span> TimeSpan<span class="token punctuation">.</span><span class="token function">FromSeconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment">//健康检查时间间隔，或者称为心跳间隔</span>
            Interval <span class="token operator">=</span> TimeSpan<span class="token punctuation">.</span><span class="token function">FromSeconds</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
            <span class="token comment">//健康检查地址</span>
            HTTP <span class="token operator">=</span> $<span class="token string">&quot;http://{ip}:{port}/api/health&quot;</span><span class="token punctuation">,</span>
            Timeout <span class="token operator">=</span> TimeSpan<span class="token punctuation">.</span><span class="token function">FromSeconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">//...... </span>
<span class="token punctuation">}</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">ConfigurationOverview</span><span class="token punctuation">(</span><span class="token class-name">ConsulClientConfiguration</span> obj<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    obj<span class="token punctuation">.</span>Address <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uri</span><span class="token punctuation">(</span><span class="token string">&quot;http://127.0.0.1:8500&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    obj<span class="token punctuation">.</span>Datacenter <span class="token operator">=</span> <span class="token string">&quot;dc1&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>注意不同实例一定要用不同的 Id，即使是相同服务的不同实例也要用不同的 Id，上面的代码用 Guid 做 Id，确保不重复。相同的服务用相同的 Name。Address、Port 是供服务消费者访问的服务器地址(或者 IP 地址)及端口号。Check 则是做服务健康检查的(解释一下)。</p> <p>在注册服务的时候还可以通过 AgentServiceRegistration 的 Tags 属性设置额外的标签。</p> <p>通过命令行启动两个实例</p> <blockquote><p>dotnet WebApplication4.dll --ip 127.0.0.1 --port 5001</p></blockquote> <blockquote><p>dotnet WebApplication4.dll --ip 127.0.0.1 --port 5002</p></blockquote> <h4 id="编写服务消费者"><a href="#编写服务消费者" class="header-anchor">#</a> 编写服务消费者</h4> <p>这里用控制台测试，真实项目中服务消费者通产哥也是另外一个 Web 应用。 nuget 安装:Consul、Newtonsoft.Json
首先编写一个 RestTemplate(模仿 Spring Cloud 中的)</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">RestTemplate</span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">String</span> consulServerUrl<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token function">RestTemplate</span><span class="token punctuation">(</span><span class="token class-name">String</span> consulServerUrl <span class="token operator">=</span> <span class="token string">&quot;http://127.0.0.1:8500&quot;</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
		<span class="token keyword">this</span><span class="token punctuation">.</span>consulServerUrl <span class="token operator">=</span> consulServerUrl <span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token comment">/// &lt;summary&gt;</span>
	<span class="token comment">/// 获取服务的第一个实现地址</span>
	<span class="token comment">/// &lt;/summary&gt;</span>
	<span class="token comment">/// &lt;param name=&quot;consulClient&quot;&gt;&lt;/param&gt;</span>
	<span class="token comment">/// &lt;param name=&quot;serviceName&quot;&gt;&lt;/param&gt;</span>
	<span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
	<span class="token keyword">private</span> <span class="token keyword">async</span> Task<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> <span class="token function">ResolveRootUrlAsync</span><span class="token punctuation">(</span><span class="token class-name">String</span> serviceName<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token keyword">var</span> consulClient <span class="token operator">=</span> 
               <span class="token keyword">new</span> <span class="token class-name">ConsulClient</span><span class="token punctuation">(</span>c <span class="token operator">=&gt;</span> c<span class="token punctuation">.</span>Address <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uri</span><span class="token punctuation">(</span>consulServerUrl<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
			<span class="token keyword">var</span> services <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">await</span> consulClient<span class="token punctuation">.</span>Agent<span class="token punctuation">.</span><span class="token function">Services</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Response<span class="token punctuation">;</span> 
            <span class="token keyword">var</span> agentServices <span class="token operator">=</span> services<span class="token punctuation">.</span><span class="token function">Where</span><span class="token punctuation">(</span>s <span class="token operator">=&gt;</span>
s<span class="token punctuation">.</span>Value<span class="token punctuation">.</span>Service<span class="token punctuation">.</span><span class="token function">Equals</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">,</span> StringComparison<span class="token punctuation">.</span>CurrentCultureIgnoreCase<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">Select</span><span class="token punctuation">(</span>s <span class="token operator">=&gt;</span> s<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//TODO:注入负载均衡策略</span>
            <span class="token keyword">var</span> agentService <span class="token operator">=</span> agentServices<span class="token punctuation">.</span><span class="token function">ElementAt</span><span class="token punctuation">(</span>Environment<span class="token punctuation">.</span>TickCount <span class="token operator">%</span>
agentServices<span class="token punctuation">.</span><span class="token function">Count</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">//根据当前TickCount对服务器个数取模，“随机”取一个机器出来</span>
            <span class="token comment">//避免“轮询” 的负载均衡策略需要计数加锁问题</span>
            <span class="token keyword">return</span> agentService<span class="token punctuation">.</span>Address <span class="token operator">+</span> <span class="token string">&quot;:&quot;</span> <span class="token operator">+</span> agentService<span class="token punctuation">.</span>Port<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  
    <span class="token keyword">private</span> <span class="token keyword">async</span> Task<span class="token operator">&lt;</span>String<span class="token operator">&gt;</span> <span class="token function">ResolveUrlAsync</span><span class="token punctuation">(</span><span class="token class-name">String</span> url<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token class-name">Uri</span> uri <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uri</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">String</span> serviceName <span class="token operator">=</span> uri<span class="token punctuation">.</span>Host<span class="token punctuation">;</span>
        <span class="token class-name">String</span> realRootUrl <span class="token operator">=</span> <span class="token keyword">await</span> <span class="token function">ResolveRootUrlAsync</span><span class="token punctuation">(</span>serviceName<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> uri<span class="token punctuation">.</span>Scheme <span class="token operator">+</span> <span class="token string">&quot;://&quot;</span> <span class="token operator">+</span> realRootUrl <span class="token operator">+</span> uri<span class="token punctuation">.</span>PathAndQuery<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  
    <span class="token keyword">public</span> <span class="token keyword">async</span> Task<span class="token operator">&lt;</span>ResponseEntity<span class="token operator">&lt;</span>T<span class="token operator">&gt;&gt;</span> <span class="token generic-method"><span class="token function">GetForEntityAsync</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token class-name">String</span> url<span class="token punctuation">,</span> <span class="token class-name">HttpRequestHeaders</span> requestHeaders <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name">HttpClient</span> httpClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name">HttpRequestMessage</span> requestMsg <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpRequestMessage</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
            <span class="token keyword">if</span> <span class="token punctuation">(</span>requestHeaders <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token keyword">var</span> header <span class="token keyword">in</span> requestHeaders<span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    requestHeaders<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span>header<span class="token punctuation">.</span>Key<span class="token punctuation">,</span> header<span class="token punctuation">.</span>Value<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            requestMsg<span class="token punctuation">.</span>Method <span class="token operator">=</span> HttpMethod<span class="token punctuation">.</span>Get<span class="token punctuation">;</span>
            requestMsg<span class="token punctuation">.</span>RequestUri <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Uri</span><span class="token punctuation">(</span><span class="token keyword">await</span> <span class="token function">ResolveUrlAsync</span><span class="token punctuation">(</span>url<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token keyword">await</span> httpClient<span class="token punctuation">.</span><span class="token function">SendAsync</span><span class="token punctuation">(</span>requestMsg<span class="token punctuation">)</span><span class="token punctuation">;</span> 
            ResponseEntity<span class="token operator">&lt;</span>T<span class="token operator">&gt;</span> respEntity <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token generic-method"><span class="token function">ResponseEntity</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
            respEntity<span class="token punctuation">.</span>StatusCode <span class="token operator">=</span> result<span class="token punctuation">.</span>StatusCode<span class="token punctuation">;</span>
            <span class="token class-name">String</span> bodyStr <span class="token operator">=</span> <span class="token keyword">await</span> result<span class="token punctuation">.</span>Content<span class="token punctuation">.</span><span class="token function">ReadAsStringAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
            respEntity<span class="token punctuation">.</span>Body <span class="token operator">=</span> JsonConvert<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">DeserializeObject</span><span class="token punctuation">&lt;</span><span class="token class-name">T</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span>bodyStr<span class="token punctuation">)</span><span class="token punctuation">;</span>
            respEntity<span class="token punctuation">.</span>Headers <span class="token operator">=</span> respEntity<span class="token punctuation">.</span>Headers<span class="token punctuation">;</span>
            <span class="token keyword">return</span> respEntity<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
	<span class="token keyword">class</span> <span class="token class-name">ResponseEntity</span><span class="token operator">&lt;</span>T<span class="token operator">&gt;</span>
	<span class="token punctuation">{</span>
    	<span class="token keyword">public</span> <span class="token class-name">HttpStatusCode</span> StatusCode <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    	<span class="token keyword">public</span> <span class="token class-name">T</span> Body <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
    	<span class="token keyword">public</span> <span class="token class-name">HttpResponseHeaders</span> Headers <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
	<span class="token punctuation">}</span> 
<span class="token punctuation">}</span>
</code></pre></div><p>编写控制台:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">using</span> Consul<span class="token punctuation">;</span>
<span class="token keyword">using</span> Newtonsoft<span class="token punctuation">.</span>Json<span class="token punctuation">;</span>
<span class="token keyword">using</span> System<span class="token punctuation">;</span>
<span class="token keyword">using</span> System<span class="token punctuation">.</span>Linq<span class="token punctuation">;</span>
<span class="token keyword">using</span> System<span class="token punctuation">.</span>Net<span class="token punctuation">;</span>
<span class="token keyword">using</span> System<span class="token punctuation">.</span>Net<span class="token punctuation">.</span>Http<span class="token punctuation">;</span>
<span class="token keyword">using</span> System<span class="token punctuation">.</span>Net<span class="token punctuation">.</span>Http<span class="token punctuation">.</span>Headers<span class="token punctuation">;</span>
<span class="token keyword">using</span> System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Tasks<span class="token punctuation">;</span>
<span class="token keyword">namespace</span> ConsoleApp1
<span class="token punctuation">{</span>
    <span class="token keyword">class</span> <span class="token class-name">Program</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">Main</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span> args<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token class-name">RestTemplate</span> rest <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">RestTemplate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">var</span> data <span class="token operator">=</span> 
           rest<span class="token punctuation">.</span>GetForEntityAsync<span class="token operator">&lt;</span><span class="token keyword">string</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span><span class="token string">&quot;http://WebApplication4/api/Values/&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Result<span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>data<span class="token punctuation">.</span>StatusCode<span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span><span class="token string">&quot;,&quot;</span><span class="token punctuation">,</span> data<span class="token punctuation">.</span>Body<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            Console<span class="token punctuation">.</span><span class="token function">ReadKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>解析RestTemplate代码。主要作用:</p> <ul><li><ol><li>根据url到Consul中根据服务的名字解析获取一个服务实例，把路径转换为实际连接的服务器;</li></ol></li></ul> <p>负载均衡，这里用的是简单的随机负载均衡，这样服务的消费者就不用自己指定要访问那个服务提供
者了，解耦、负载均衡。</p> <ul><li><ol start="2"><li>负载均衡还可以根据权重随机(不同服务器的性能不一样，这样注册服务的时候通过Tags来区</li></ol></li></ul> <p>分)，还可以根据消费者IP地址来选择服务实例(涉及到一致性Hash的优化)等。</p> <ul><li><ol start="3"><li>RestTemplate还负责把响应的json反序列化返回结果。</li></ol></li></ul> <h4 id="简化服务的注册"><a href="#简化服务的注册" class="header-anchor">#</a> 简化服务的注册</h4> <p>每次启动、注册服务都要指定一个端口，本地测试集群的时候可能要启动多个实例，很麻烦。
在 ASP.Net Core 中只要设定端口为 0，那么服务器会随机找一个可用的端口绑定(测试一下)。 但是没有找到读取到这个随机端口号的方法。
因此自己写:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token comment">/// &lt;summary&gt;</span>
<span class="token comment">/// 产生一个介于 minPort-maxPort 之间的随机可用端口</span>
<span class="token comment">/// &lt;/summary&gt;</span>
<span class="token comment">/// &lt;param name=&quot;minPort&quot;&gt;&lt;/param&gt;</span>
<span class="token comment">/// &lt;param name=&quot;maxPort&quot;&gt;&lt;/param&gt;</span>
<span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">GetRandAvailablePort</span><span class="token punctuation">(</span><span class="token keyword">int</span> minPort<span class="token operator">=</span><span class="token number">1024</span><span class="token punctuation">,</span><span class="token keyword">int</span> maxPort <span class="token operator">=</span> <span class="token number">65535</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token class-name">Random</span> rand <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Random</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span><span class="token keyword">true</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
    	<span class="token keyword">int</span> port <span class="token operator">=</span> rand<span class="token punctuation">.</span><span class="token function">Next</span><span class="token punctuation">(</span>minPort<span class="token punctuation">,</span> maxPort<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token function">IsPortInUsed</span><span class="token punctuation">(</span>port<span class="token punctuation">)</span><span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
    		<span class="token keyword">return</span> port<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span> 
<span class="token punctuation">}</span>

<span class="token comment">/// &lt;summary&gt;</span>
<span class="token comment">/// 判断 port 端口是否在使用中</span>
<span class="token comment">/// &lt;/summary&gt;</span>
<span class="token comment">/// &lt;param name=&quot;port&quot;&gt;&lt;/param&gt;</span>
<span class="token comment">/// &lt;returns&gt;&lt;/returns&gt;</span>
<span class="token keyword">public</span> <span class="token keyword">static</span> <span class="token keyword">bool</span> <span class="token function">IsPortInUsed</span><span class="token punctuation">(</span><span class="token keyword">int</span> port<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">//using System.Net.NetworkInformation;</span>
    <span class="token class-name">IPGlobalProperties</span> ipGlobalProperties <span class="token operator">=</span> IPGlobalProperties<span class="token punctuation">.</span><span class="token function">GetIPGlobalProperties</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	IPEndPoint<span class="token punctuation">[</span><span class="token punctuation">]</span> ipsTCP <span class="token operator">=</span> ipGlobalProperties<span class="token punctuation">.</span><span class="token function">GetActiveTcpListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span><span class="token punctuation">(</span>ipsTCP<span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span>p<span class="token operator">=&gt;</span>p<span class="token punctuation">.</span>Port<span class="token operator">==</span>port<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
    	<span class="token keyword">return</span> <span class="token keyword">true</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	IPEndPoint<span class="token punctuation">[</span><span class="token punctuation">]</span> ipsUDP <span class="token operator">=</span> ipGlobalProperties<span class="token punctuation">.</span><span class="token function">GetActiveUdpListeners</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> 
 	<span class="token keyword">if</span> <span class="token punctuation">(</span>ipsUDP<span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span>p <span class="token operator">=&gt;</span> p<span class="token punctuation">.</span>Port <span class="token operator">==</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	TcpConnectionInformation<span class="token punctuation">[</span><span class="token punctuation">]</span> tcpConnInfoArray <span class="token operator">=</span> ipGlobalProperties<span class="token punctuation">.</span><span class="token class-name">GetActiveTcpC</span>
<span class="token function">onnections</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>tcpConnInfoArray<span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span>conn <span class="token operator">=&gt;</span> conn<span class="token punctuation">.</span>LocalEndPoint<span class="token punctuation">.</span>Port <span class="token operator">==</span> port<span class="token punctuation">)</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token keyword">true</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
	<span class="token keyword">return</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>在程序启动的时候如果 port=0 或者没有指定 port，则自己调用 GetRandAvailablePort 获取可
用端口。</p> <p>如鹏网《Net微服务》-by杨中科</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time"> 2019年 12月 28日 15:53:50</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/post/oldblog/NLog教程.html" class="prev">NLog教程</a></span> <span class="next"><a href="/post/oldblog/微服务-JWT.html">微服务 - JWT 算法</a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.fa3e3824.js" defer></script><script src="/assets/js/2.230529bd.js" defer></script><script src="/assets/js/32.daf1012d.js" defer></script>
  </body>
</html>
