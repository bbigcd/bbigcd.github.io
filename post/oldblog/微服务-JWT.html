<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>微服务 - JWT 算法 | bbigcd</title>
    <meta name="description" content="Make more time">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.0cbbf90a.css" as="style"><link rel="preload" href="/assets/js/app.fa3e3824.js" as="script"><link rel="preload" href="/assets/js/2.230529bd.js" as="script"><link rel="preload" href="/assets/js/33.9f79b5b3.js" as="script"><link rel="prefetch" href="/assets/js/10.c93fe082.js"><link rel="prefetch" href="/assets/js/11.4bf3ae7f.js"><link rel="prefetch" href="/assets/js/12.01c45e0e.js"><link rel="prefetch" href="/assets/js/13.d9d858d9.js"><link rel="prefetch" href="/assets/js/14.00d956f4.js"><link rel="prefetch" href="/assets/js/15.679c6742.js"><link rel="prefetch" href="/assets/js/16.abbcd59e.js"><link rel="prefetch" href="/assets/js/17.1f5585d5.js"><link rel="prefetch" href="/assets/js/18.149d6c4f.js"><link rel="prefetch" href="/assets/js/19.4dd5acbe.js"><link rel="prefetch" href="/assets/js/20.874851b7.js"><link rel="prefetch" href="/assets/js/21.e8fab656.js"><link rel="prefetch" href="/assets/js/22.74ef4341.js"><link rel="prefetch" href="/assets/js/23.0815466b.js"><link rel="prefetch" href="/assets/js/24.3923d245.js"><link rel="prefetch" href="/assets/js/25.dd992728.js"><link rel="prefetch" href="/assets/js/26.f9a0d7a7.js"><link rel="prefetch" href="/assets/js/27.54f139b7.js"><link rel="prefetch" href="/assets/js/28.070cfa63.js"><link rel="prefetch" href="/assets/js/29.eb08d370.js"><link rel="prefetch" href="/assets/js/3.447720c6.js"><link rel="prefetch" href="/assets/js/30.e66848e4.js"><link rel="prefetch" href="/assets/js/31.0438d4db.js"><link rel="prefetch" href="/assets/js/32.daf1012d.js"><link rel="prefetch" href="/assets/js/34.086724a3.js"><link rel="prefetch" href="/assets/js/35.90c07cc0.js"><link rel="prefetch" href="/assets/js/36.056ad52c.js"><link rel="prefetch" href="/assets/js/4.0f091beb.js"><link rel="prefetch" href="/assets/js/5.4c5d2735.js"><link rel="prefetch" href="/assets/js/6.a4af8558.js"><link rel="prefetch" href="/assets/js/7.8feeb04b.js"><link rel="prefetch" href="/assets/js/8.1af69973.js"><link rel="prefetch" href="/assets/js/9.e612d3ea.js">
    <link rel="stylesheet" href="/assets/css/0.styles.0cbbf90a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">bbigcd</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/netcore/" class="nav-link">NetCore</a></div><div class="nav-item"><a href="/csharp/" class="nav-link">CSharp</a></div><div class="nav-item"><a href="/post/" class="nav-link router-link-active">Other</a></div><div class="nav-item"><a href="/about-me/" class="nav-link">AboutMe</a></div><div class="nav-item"><a href="https://www.github.com/bbigcd" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/netcore/" class="nav-link">NetCore</a></div><div class="nav-item"><a href="/csharp/" class="nav-link">CSharp</a></div><div class="nav-item"><a href="/post/" class="nav-link router-link-active">Other</a></div><div class="nav-item"><a href="/about-me/" class="nav-link">AboutMe</a></div><div class="nav-item"><a href="https://www.github.com/bbigcd" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>旧博客内容</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/post/oldblog/ASP.NET Web Api 2 Http 消息生命周期.html" class="sidebar-link">ASP.NET Web Api 2 Http 消息生命周期</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/post/oldblog/ASP.NET中关于Async和Await的概述.html" class="sidebar-link">ASP.NET 中关于Async和Await的概述【译】</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/post/oldblog/AutoMapper使用学习笔记.html" class="sidebar-link">AutoMapper使用学习笔记</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/post/oldblog/Dapper框架.html" class="sidebar-link">Dapper框架</a></li><li><a href="/post/oldblog/MongoDB-CSharp-Driver-快速入门指南.html" class="sidebar-link">MongoDB C# Driver 快速入门指南</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/post/oldblog/NLog教程.html" class="sidebar-link">NLog教程</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/post/oldblog/微服务-Consul服务治理发现.html" class="sidebar-link">微服务 - Consul服务治理发现</a></li><li><a href="/post/oldblog/微服务-JWT.html" class="active sidebar-link">微服务 - JWT 算法</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/post/oldblog/微服务-Ocelot API 网关.html" class="sidebar-link">微服务 - Ocelot API 网关</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/post/oldblog/微服务-Polly熔断降级.html" class="sidebar-link">微服务 - Polly熔断降级</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/post/oldblog/Redis-CSharp-Driver.html" class="sidebar-link">Redis C# Driver - StackExchange.Redis</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h3 id="jwt-算法"><a href="#jwt-算法" class="header-anchor">#</a> JWT 算法</h3> <h3 id="一、jwt简介"><a href="#一、jwt简介" class="header-anchor">#</a> 一、JWT简介</h3> <p>内部 Restful 接口可以“我家大门常打开”，但是如果要给 app 等使用的接口，则需要 做权限校验，不能谁都随便调用。</p> <p>Restful 接口不是 web 网站，App 中很难直接处理 SessionId，而且 Cookie 有跨域访问的 限制，所以一般不能直接用后端 Web 框架内置的 Session 机制。但是可以用类似 Session 的 机制，用户登录之后返回一个类似 SessionId 的东西，服务器端把 SessionId 和用户的信息对 应关系保存到 Redis 等地方，客户端把 SessionId 保存起来，以后每次请求的时候都带着这个 SessionId。</p> <p>用类似 Session 这种机制的坏处：需要集中的 Session 机制服务器；不可以在 nginx、CDN 等静态文件处理服务器上校验权限；每次都要根据 SessionId 去 Redis 服务器获取用户信息， 效率低；</p> <p>JWT（Json Web Token）是现在流行的一种对 Restful 接口进行验证的机制的基础。JWT 的 特点：把用户信息放到一个 JWT 字符串中，用户信息部分是明文的，再加上一部分签名区 域，签名部分是服务器对于“明文部分+秘钥”加密的，这个加密信息只有服务器端才能解 析。用户端只是存储、转发这个 JWT 字符串。如果客户端篡改了明文部分，那么服务器端 解密时候会报错。</p> <p>JWT 由三块组成，可以把用户名、用户 Id 等保存到 Payload 部分 ：</p> <p><img src="https://upload-images.jianshu.io/upload_images/1366611-4f38fe9639ce7a6c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240" alt=""></p> <p>注意Payload和Header部分都是Base64编码，可以轻松的Base64解码回来。因此Payload 部分约等于是明文的，因此不能在 Payload 中保存不能让别人看到的机密信息。虽然说 Payload 部分约等于是明文的，但是不用担心 Payload 被篡改，因为 Signature 部分是根据 header+payload+secretKey 进行加密算出来的，如果 Payload 被篡改，就可以根据 Signature 解密时候校验。</p> <p>用 JWT 做权限验证的好处：无状态，更有利于分布式系统，不需要集中的 Session 机制 服务器；可以在 nginx、CDN 等静态文件处理服务器上校验权限；获取用户信息直接从 JWT 中就可以读取，效率高；</p> <h3 id="二、-net-中使用-jwt-算法"><a href="#二、-net-中使用-jwt-算法" class="header-anchor">#</a> 二、.NET 中使用 JWT 算法</h3> <ul><li><p>1）加密</p> <p>Install-Packgae JWT</p></li></ul> <div class="language-csharp extra-class"><pre class="language-csharp"><code>  <span class="token keyword">var</span> payload <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Dictionary</span><span class="token operator">&lt;</span><span class="token keyword">string</span><span class="token punctuation">,</span> <span class="token keyword">object</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>
       <span class="token punctuation">{</span> <span class="token string">&quot;UserId&quot;</span><span class="token punctuation">,</span> <span class="token number">123</span> <span class="token punctuation">}</span><span class="token punctuation">,</span>
       <span class="token punctuation">{</span> <span class="token string">&quot;UserName&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;admin&quot;</span> <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> secret <span class="token operator">=</span> <span class="token string">&quot;GQDstcKsx0NHjPOuXOYg5MbeJ1XT0uFiwDVvVBrk&quot;</span><span class="token punctuation">;</span><span class="token comment">//不要泄露</span>
  <span class="token class-name">IJwtAlgorithm</span> algorithm <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HMACSHA256Algorithm</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">IJsonSerializer</span> serializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JsonNetSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">IBase64UrlEncoder</span> urlEncoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JwtBase64UrlEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token class-name">IJwtEncoder</span> encoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JwtEncoder</span><span class="token punctuation">(</span>algorithm<span class="token punctuation">,</span> serializer<span class="token punctuation">,</span> urlEncoder<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> token <span class="token operator">=</span> encoder<span class="token punctuation">.</span><span class="token function">Encode</span><span class="token punctuation">(</span>payload<span class="token punctuation">,</span> secret<span class="token punctuation">)</span><span class="token punctuation">;</span>
  Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><ul><li>2 ) 解密</li></ul> <div class="language-csharp extra-class"><pre class="language-csharp"><code>  <span class="token keyword">var</span> token <span class="token operator">=</span>
  <span class="token string">&quot;eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJVc2VySWQiOjEyMywiVXNlck5hbWUiOiJhZG1pbiJ9.Qjw1epD5P6p4Yy2yju3-fkq28PddznqRj3ESfALQy_U&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">var</span> secret <span class="token operator">=</span> <span class="token string">&quot;GQDstcKsx0NHjPOuXOYg5MbeJ1XT0uFiwDVvVBrk&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span>
  <span class="token punctuation">{</span>
      <span class="token class-name">IJsonSerializer</span> serializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JsonNetSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">IDateTimeProvider</span> provider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UtcDateTimeProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">IJwtValidator</span> validator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JwtValidator</span><span class="token punctuation">(</span>serializer<span class="token punctuation">,</span> provider<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">IBase64UrlEncoder</span> urlEncoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JwtBase64UrlEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">IJwtDecoder</span> decoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JwtDecoder</span><span class="token punctuation">(</span>serializer<span class="token punctuation">,</span> validator<span class="token punctuation">,</span> urlEncoder<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> json <span class="token operator">=</span> decoder<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span>token<span class="token punctuation">,</span> secret<span class="token punctuation">,</span> verify<span class="token punctuation">:</span> <span class="token keyword">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">FormatException</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
      Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;Token format invalid&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TokenExpiredException</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
      Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;Token has expired&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">SignatureVerificationException</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
      Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;Token has invalid signature&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div><p>试着篡改一下 Payload 部分。</p> <ul><li><p>3 ) 过期时间</p> <p>在 payload 中增加一个名字为 exp 的值，值为过期时间和 1970/1/1 00:00：00 相差的秒数</p></li></ul> <div class="language-csharp extra-class"><pre class="language-csharp"><code>  <span class="token keyword">double</span> exp <span class="token operator">=</span> <span class="token punctuation">(</span>DateTime<span class="token punctuation">.</span>UtcNow<span class="token punctuation">.</span><span class="token function">AddSeconds</span><span class="token punctuation">(</span><span class="token number">10</span><span class="token punctuation">)</span> <span class="token operator">-</span> <span class="token keyword">new</span> <span class="token class-name">DateTime</span><span class="token punctuation">(</span><span class="token number">1970</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span>TotalSeconds<span class="token punctuation">;</span> 
</code></pre></div><ul><li><p>4）不用密钥解析数据 payload</p> <p>因为 payload 部分是明文的，所以在不知道秘钥的时候也可以用 Decode、DecodeToObject 等不 需要秘钥的方法把 payload 部分解析出来。</p></li></ul> <div class="language-csharp extra-class"><pre class="language-csharp"><code>  <span class="token keyword">var</span> token <span class="token operator">=</span> <span class="token string">&quot;eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJVc2VySWQiOjEyMywiVXNlck5hbWUiOiJhZG1pbiJ9.Qjw1epD5P6p4Yy2yju3-fkq28PddznqRj3ESfALQy_U&quot;</span><span class="token punctuation">;</span>
  <span class="token keyword">try</span>
  <span class="token punctuation">{</span>
      <span class="token class-name">IJsonSerializer</span> serializer <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JsonNetSerializer</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">IDateTimeProvider</span> provider <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">UtcDateTimeProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">IJwtValidator</span> validator <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JwtValidator</span><span class="token punctuation">(</span>serializer<span class="token punctuation">,</span> provider<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">IBase64UrlEncoder</span> urlEncoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JwtBase64UrlEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">IJwtDecoder</span> decoder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">JwtDecoder</span><span class="token punctuation">(</span>serializer<span class="token punctuation">,</span> validator<span class="token punctuation">,</span> urlEncoder<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">var</span> json <span class="token operator">=</span> decoder<span class="token punctuation">.</span><span class="token function">Decode</span><span class="token punctuation">(</span>token<span class="token punctuation">)</span><span class="token punctuation">;</span>
      Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">FormatException</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
      Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;Token format invalid&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">TokenExpiredException</span><span class="token punctuation">)</span>
  <span class="token punctuation">{</span>
      Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;Token has expired&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time"> 2019年 12月 28日 15:53:50</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/post/oldblog/微服务-Consul服务治理发现.html" class="prev">微服务 - Consul服务治理发现</a></span> <span class="next"><a href="/post/oldblog/微服务-Ocelot API 网关.html">微服务 - Ocelot API 网关</a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.fa3e3824.js" defer></script><script src="/assets/js/2.230529bd.js" defer></script><script src="/assets/js/33.9f79b5b3.js" defer></script>
  </body>
</html>
