<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>微服务 - Polly熔断降级 | bbigcd</title>
    <meta name="description" content="Make more time">
    <link rel="icon" href="/favicon.ico">
    
    <link rel="preload" href="/assets/css/0.styles.0cbbf90a.css" as="style"><link rel="preload" href="/assets/js/app.fa3e3824.js" as="script"><link rel="preload" href="/assets/js/2.230529bd.js" as="script"><link rel="preload" href="/assets/js/35.90c07cc0.js" as="script"><link rel="prefetch" href="/assets/js/10.c93fe082.js"><link rel="prefetch" href="/assets/js/11.4bf3ae7f.js"><link rel="prefetch" href="/assets/js/12.01c45e0e.js"><link rel="prefetch" href="/assets/js/13.d9d858d9.js"><link rel="prefetch" href="/assets/js/14.00d956f4.js"><link rel="prefetch" href="/assets/js/15.679c6742.js"><link rel="prefetch" href="/assets/js/16.abbcd59e.js"><link rel="prefetch" href="/assets/js/17.1f5585d5.js"><link rel="prefetch" href="/assets/js/18.149d6c4f.js"><link rel="prefetch" href="/assets/js/19.4dd5acbe.js"><link rel="prefetch" href="/assets/js/20.874851b7.js"><link rel="prefetch" href="/assets/js/21.e8fab656.js"><link rel="prefetch" href="/assets/js/22.74ef4341.js"><link rel="prefetch" href="/assets/js/23.0815466b.js"><link rel="prefetch" href="/assets/js/24.3923d245.js"><link rel="prefetch" href="/assets/js/25.dd992728.js"><link rel="prefetch" href="/assets/js/26.f9a0d7a7.js"><link rel="prefetch" href="/assets/js/27.54f139b7.js"><link rel="prefetch" href="/assets/js/28.070cfa63.js"><link rel="prefetch" href="/assets/js/29.eb08d370.js"><link rel="prefetch" href="/assets/js/3.447720c6.js"><link rel="prefetch" href="/assets/js/30.e66848e4.js"><link rel="prefetch" href="/assets/js/31.0438d4db.js"><link rel="prefetch" href="/assets/js/32.daf1012d.js"><link rel="prefetch" href="/assets/js/33.9f79b5b3.js"><link rel="prefetch" href="/assets/js/34.086724a3.js"><link rel="prefetch" href="/assets/js/36.056ad52c.js"><link rel="prefetch" href="/assets/js/4.0f091beb.js"><link rel="prefetch" href="/assets/js/5.4c5d2735.js"><link rel="prefetch" href="/assets/js/6.a4af8558.js"><link rel="prefetch" href="/assets/js/7.8feeb04b.js"><link rel="prefetch" href="/assets/js/8.1af69973.js"><link rel="prefetch" href="/assets/js/9.e612d3ea.js">
    <link rel="stylesheet" href="/assets/css/0.styles.0cbbf90a.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">bbigcd</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/netcore/" class="nav-link">NetCore</a></div><div class="nav-item"><a href="/csharp/" class="nav-link">CSharp</a></div><div class="nav-item"><a href="/post/" class="nav-link router-link-active">Other</a></div><div class="nav-item"><a href="/about-me/" class="nav-link">AboutMe</a></div><div class="nav-item"><a href="https://www.github.com/bbigcd" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/netcore/" class="nav-link">NetCore</a></div><div class="nav-item"><a href="/csharp/" class="nav-link">CSharp</a></div><div class="nav-item"><a href="/post/" class="nav-link router-link-active">Other</a></div><div class="nav-item"><a href="/about-me/" class="nav-link">AboutMe</a></div><div class="nav-item"><a href="https://www.github.com/bbigcd" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>旧博客内容</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/post/oldblog/ASP.NET Web Api 2 Http 消息生命周期.html" class="sidebar-link">ASP.NET Web Api 2 Http 消息生命周期</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/post/oldblog/ASP.NET中关于Async和Await的概述.html" class="sidebar-link">ASP.NET 中关于Async和Await的概述【译】</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/post/oldblog/AutoMapper使用学习笔记.html" class="sidebar-link">AutoMapper使用学习笔记</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/post/oldblog/Dapper框架.html" class="sidebar-link">Dapper框架</a></li><li><a href="/post/oldblog/MongoDB-CSharp-Driver-快速入门指南.html" class="sidebar-link">MongoDB C# Driver 快速入门指南</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/post/oldblog/NLog教程.html" class="sidebar-link">NLog教程</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/post/oldblog/微服务-Consul服务治理发现.html" class="sidebar-link">微服务 - Consul服务治理发现</a></li><li><a href="/post/oldblog/微服务-JWT.html" class="sidebar-link">微服务 - JWT 算法</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/post/oldblog/微服务-Ocelot API 网关.html" class="sidebar-link">微服务 - Ocelot API 网关</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/post/oldblog/微服务-Polly熔断降级.html" class="active sidebar-link">微服务 - Polly熔断降级</a><ul class="sidebar-sub-headers"></ul></li><li><a href="/post/oldblog/Redis-CSharp-Driver.html" class="sidebar-link">Redis C# Driver - StackExchange.Redis</a><ul class="sidebar-sub-headers"></ul></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h3 id="一、什么是熔断降级"><a href="#一、什么是熔断降级" class="header-anchor">#</a> 一、什么是熔断降级</h3> <p>熔断就是“保险丝”。当出现某些状况时，切断服务，从而防止应用程序不断地尝试执 行可能会失败的操作给系统造成“雪崩”，或者大量的超时等待导致系统卡死。</p> <p>降级的目的是当某个服务提供者发生故障的时候，向调用方返回一个错误响应或者替代 响应。举例子：调用联通接口服务器发送短信失败之后，改用移动短信服务器发送，如果移 动短信服务器也失败，则改用电信短信服务器，如果还失败，则返回“失败”响应；在从推 荐商品服务器加载数据的时候，如果失败，则改用从缓存中加载，如果缓存中也加载失败， 则返回一些本地替代数据。</p> <h3 id="二、polly-简介"><a href="#二、polly-简介" class="header-anchor">#</a> 二、Polly 简介</h3> <p>.Net Core 中有一个被.Net 基金会认可的库 Polly，可以用来简化熔断降级的处理。主要 功能：重试（Retry）；断路器（Circuit-breaker）；超时检测（Timeout）；缓存（Cache）； 降级（FallBack）；</p> <p>官网：<code>https://github.com/App-vNext/Polly</code></p> <p>介绍文章：<code>https://www.cnblogs.com/CreateMyself/p/7589397.html</code></p> <p><code>Install-Package Polly -Version 6.0.1</code></p> <p>Polly 的策略由“故障”和“动作”两部分组成，“故障”包括异常、超时、返回值错 误等情况，“动作”包括</p> <ul><li>FallBack（降级）</li> <li>重试（Retry）</li> <li>熔断（Circuit-breaker）等。</li></ul> <p>策略用来执行可能会有有故障的业务代码，当业务代码出现“故障”中情况的时候就执 行“动作”。</p> <p>由于实际业务代码中故障情况很难重现出来，所以 Polly 这一些都是用一些无意义的代 码模拟出来。</p> <p>Polly 也支持请求缓存“数据不变化则不重复自行代码”，但是和新版本兼容不好，而 且功能局限性很大，因此这里不讲。</p> <p>由于调试器存在，看不清楚 Polly 的执行过程，因此本节都用【开始执行（不调试）】</p> <h3 id="三、polly-简单使用"><a href="#三、polly-简单使用" class="header-anchor">#</a> 三、Polly 简单使用</h3> <p>使用Policy的静态方法创建ISyncPolicy实现类对象，创建方法既有同步方法也有异步方法，根 据自己的需要选择。下面先演示同步的，异步的用法类似。</p> <p>举例：当发生ArgumentException异常的时候，执行Fallback代码。</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token class-name">Policy</span> policy <span class="token operator">=</span> Policy
<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Handle</span><span class="token punctuation">&lt;</span><span class="token class-name">ArgumentException</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//故障</span>
<span class="token punctuation">.</span><span class="token function">Fallback</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token comment">//动作</span>
<span class="token punctuation">{</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;执行出错&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
policy<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token comment">//在策略中执行业务代码</span>
    <span class="token comment">//这里是可能会产生问题的业务系统代码</span>
	Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;开始任务&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Hello world!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;完成任务&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Console<span class="token punctuation">.</span><span class="token function">ReadKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>如果没有被Handle处理的异常，则会导致未处理异常被抛出。</p> <p>还可以用Fallback的其他重载获取异常信息：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token class-name">Policy</span> policy <span class="token operator">=</span> Policy
<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Handle</span><span class="token punctuation">&lt;</span><span class="token class-name">ArgumentException</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//故障</span>
<span class="token punctuation">.</span><span class="token function">Fallback</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token comment">//动作</span>
<span class="token punctuation">{</span>
	Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;执行出错&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span>ex<span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
policy<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;开始任务&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Hello world!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;完成任务&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>如果Execute中的代码是带返回值的，那么只要使用带泛型的Policy类即可：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>Policy<span class="token operator">&lt;</span><span class="token keyword">string</span><span class="token operator">&gt;</span> policy <span class="token operator">=</span> Policy<span class="token operator">&lt;</span><span class="token keyword">string</span><span class="token operator">&gt;</span>
<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Handle</span><span class="token punctuation">&lt;</span><span class="token class-name">Exception</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//故障</span>
<span class="token punctuation">.</span><span class="token function">Fallback</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span><span class="token comment">//动作</span>
<span class="token punctuation">{</span>
	Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;执行出错&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token string">&quot;降级的值&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">string</span> <span class="token keyword">value</span> <span class="token operator">=</span> policy<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;开始任务&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string">&quot;Hello world!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;完成任务&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token string">&quot;正常的值&quot;</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;返回值：&quot;</span><span class="token operator">+</span><span class="token keyword">value</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>FallBack的重载方法也非常多，有的异常可以直接提供降级后的值。</p> <ul><li>异常中还可以通过lambda表达式对异常判断“满足***条件的异常我才处理”，简单看看试试 重载即可。还可以多个Or处理各种不同的异常。</li> <li>还可以用HandleResult等判断返回值进行故障判断等，我感觉没太大必要。</li></ul> <h3 id="四、重试处理"><a href="#四、重试处理" class="header-anchor">#</a> 四、重试处理</h3> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token class-name">Policy</span> policy <span class="token operator">=</span> Policy
<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Handle</span><span class="token punctuation">&lt;</span><span class="token class-name">Exception</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">RetryForever</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
policy<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;开始任务&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">.</span>Second <span class="token operator">%</span> <span class="token number">10</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string">&quot;出错&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;完成任务&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

</code></pre></div><ul><li>RetryForever()是一直重试直到成功</li> <li>Retry()是重试最多一次</li> <li>Retry(n) 是重试最多n次</li> <li>WaitAndRetry()可以实现“如果出错等待100ms再试还不行再等150ms秒。。。。”，重载方法很 多，不再一一介绍。还有WaitAndRetryForever。</li></ul> <h3 id="五、短路保护-circuit-breaker"><a href="#五、短路保护-circuit-breaker" class="header-anchor">#</a> 五、短路保护 Circuit Breaker</h3> <p>出现N次连续错误，则把“熔断器”（保险丝）熔断，等待一段时间，等待这段时间内如果再Execute 则直接抛出BrokenCircuitException异常，根本不会再去尝试调用业务代码。等待时间过去之后，再 执行Execute的时候如果又错了（一次就够了），那么继续熔断一段时间，否则就恢复正常。</p> <p>这样就避免一个服务已经不可用了，还是使劲的请求给系统造成更大压力。</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token class-name">Policy</span> policy <span class="token operator">=</span> Policy
 <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Handle</span><span class="token punctuation">&lt;</span><span class="token class-name">Exception</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
 <span class="token punctuation">.</span><span class="token function">CircuitBreaker</span><span class="token punctuation">(</span><span class="token number">6</span><span class="token punctuation">,</span>TimeSpan<span class="token punctuation">.</span><span class="token function">FromSeconds</span><span class="token punctuation">(</span><span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//连续出错6次之后熔断5秒(不会再去尝试执行业务代码）。</span>
<span class="token keyword">while</span><span class="token punctuation">(</span><span class="token keyword">true</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;开始Execute&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">try</span>
	<span class="token punctuation">{</span>
		policy<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
			Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;开始任务&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string">&quot;出错&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;完成任务&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">catch</span><span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;execute出错&quot;</span><span class="token operator">+</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">500</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span> 
</code></pre></div><p>其计数的范围是policy对象，所以如果想整个服务器全局对于一段代码做短路保护，则需要共用 一个policy对象。</p> <p><code>https://andrewlock.net/when-you-use-the-polly-circuit-breaker-make-sure-you-share-your-policy-instances-2/</code></p> <h3 id="六、策略封装"><a href="#六、策略封装" class="header-anchor">#</a> 六、策略封装</h3> <p>可以把多个ISyncPolicy合并到一起执行:</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>policy3 <span class="token operator">=</span> policy1<span class="token punctuation">.</span><span class="token function">Wrap</span><span class="token punctuation">(</span>policy2<span class="token punctuation">)</span><span class="token punctuation">;</span> 
</code></pre></div><p>执行policy3就会把policy1、policy2封装到一起执行</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>policy9 <span class="token operator">=</span> Policy<span class="token punctuation">.</span><span class="token function">Wrap</span><span class="token punctuation">(</span>policy1<span class="token punctuation">,</span> policy2<span class="token punctuation">,</span> policy3<span class="token punctuation">,</span> policy4<span class="token punctuation">,</span> policy5<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>把更多一起封装。</p> <h3 id="七、超时处理"><a href="#七、超时处理" class="header-anchor">#</a> 七、超时处理</h3> <p>这些处理不能简单的链式调用，要用到Wrap。例如下面实现“出现异常则重试三次，如果还出错 就FallBack”这样是不行的</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token class-name">Policy</span> policy <span class="token operator">=</span> Policy
<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Handle</span><span class="token punctuation">&lt;</span><span class="token class-name">Exception</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">Retry</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">Fallback</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span> Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;执行出错&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//这样不行</span>
policy<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;开始任务&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">ArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;Hello world!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;完成任务&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>注意Wrap是有包裹顺序的，内层的故障如果没有被处理则会抛出到外层。</p> <p>下面代码实现了“出现异常则重试三次，如果还出错就FallBack</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token class-name">Policy</span> policyRetry <span class="token operator">=</span> Policy<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Handle</span><span class="token punctuation">&lt;</span><span class="token class-name">Exception</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">Retry</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token class-name">Policy</span> policyFallback <span class="token operator">=</span> Policy<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Handle</span><span class="token punctuation">&lt;</span><span class="token class-name">Exception</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">Fallback</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;降级&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">//Wrap：包裹。policyRetry在里面，policyFallback裹在外面。</span>
<span class="token comment">//如果里面出现了故障，则把故障抛出来给外面</span>
<span class="token class-name">Policy</span> policy <span class="token operator">=</span> policyFallback<span class="token punctuation">.</span><span class="token function">Wrap</span><span class="token punctuation">(</span>policyRetry<span class="token punctuation">)</span><span class="token punctuation">;</span>
policy<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;开始任务&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">if</span> <span class="token punctuation">(</span>DateTime<span class="token punctuation">.</span>Now<span class="token punctuation">.</span>Second <span class="token operator">%</span> <span class="token number">10</span> <span class="token operator">!=</span> <span class="token number">0</span><span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">Exception</span><span class="token punctuation">(</span><span class="token string">&quot;出错&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;完成任务&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>Timeout是定义超时故障。</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token class-name">Policy</span> policy <span class="token operator">=</span> Policy<span class="token punctuation">.</span><span class="token function">Timeout</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> TimeoutStrategy<span class="token punctuation">.</span>Pessimistic<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">// 创建一个3秒钟（注意单位）的超时策略。</span>
</code></pre></div><p>Timeout生成的Policy要和其他Policy一起Wrap使用。</p> <p>超时策略一般不能直接用，而是和其他封装到一起用：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token class-name">Policy</span> policy <span class="token operator">=</span> Policy
<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Handle</span><span class="token punctuation">&lt;</span><span class="token class-name">Exception</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token comment">//定义所处理的故障</span>
<span class="token punctuation">.</span><span class="token function">Fallback</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
	Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;执行出错&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
policy <span class="token operator">=</span> policy<span class="token punctuation">.</span><span class="token function">Wrap</span><span class="token punctuation">(</span>Policy<span class="token punctuation">.</span><span class="token function">Timeout</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">,</span> TimeoutStrategy<span class="token punctuation">.</span>Pessimistic<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
policy<span class="token punctuation">.</span><span class="token function">Execute</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;开始任务&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	Thread<span class="token punctuation">.</span><span class="token function">Sleep</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;完成任务&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>上面的代码就是如果执行超过2秒钟，则直接Fallback。</p> <p>这个的用途：请求网络接口，避免接口长期没有响应造成系统卡死 。</p> <h3 id="八、-polly-的异步用法"><a href="#八、-polly-的异步用法" class="header-anchor">#</a> 八、 Polly 的异步用法</h3> <p>所有方法都用Async方法即可，Handle由于只是定义异常，所以不需要异常方法： 带返回值的例子：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code>Policy<span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span> policy <span class="token operator">=</span> Policy<span class="token operator">&lt;</span><span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token operator">&gt;</span>
<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Handle</span><span class="token punctuation">&lt;</span><span class="token class-name">Exception</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">FallbackAsync</span><span class="token punctuation">(</span><span class="token keyword">async</span> c <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;执行出错&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token number">0</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">async</span> r<span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>r<span class="token punctuation">.</span>Exception<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
policy <span class="token operator">=</span> policy<span class="token punctuation">.</span><span class="token function">WrapAsync</span><span class="token punctuation">(</span>Policy<span class="token punctuation">.</span><span class="token function">TimeoutAsync</span><span class="token punctuation">(</span><span class="token number">20</span><span class="token punctuation">,</span> TimeoutStrategy<span class="token punctuation">.</span>Pessimistic<span class="token punctuation">,</span>
<span class="token keyword">async</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> timespan<span class="token punctuation">,</span> task<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
	Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;timeout&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">var</span> bytes <span class="token operator">=</span> <span class="token keyword">await</span> policy<span class="token punctuation">.</span><span class="token function">ExecuteAsync</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;开始任务&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token class-name">HttpClient</span> httpClient <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HttpClient</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">var</span> result <span class="token operator">=</span> <span class="token keyword">await</span>
		httpClient<span class="token punctuation">.</span><span class="token function">GetByteArrayAsync</span><span class="token punctuation">(</span>
        <span class="token string">&quot;http://static.rupeng.com/upload/chatimage/20183/07EB793A4C247A654B31B4D14EC64BCA.png&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;完成任务&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token keyword">return</span> result<span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;bytes长度&quot;</span><span class="token operator">+</span>bytes<span class="token punctuation">.</span>Length<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>没返回值的例子</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token class-name">Policy</span> policy <span class="token operator">=</span> Policy
<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Handle</span><span class="token punctuation">&lt;</span><span class="token class-name">Exception</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">.</span><span class="token function">FallbackAsync</span><span class="token punctuation">(</span><span class="token keyword">async</span> c <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;执行出错&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">,</span><span class="token keyword">async</span> ex<span class="token operator">=&gt;</span> <span class="token punctuation">{</span><span class="token comment">//对于没有返回值的，这个参数直接是异常</span>
	Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>ex<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
policy <span class="token operator">=</span> policy<span class="token punctuation">.</span><span class="token function">WrapAsync</span><span class="token punctuation">(</span>Policy<span class="token punctuation">.</span><span class="token function">TimeoutAsync</span><span class="token punctuation">(</span><span class="token number">3</span><span class="token punctuation">,</span> TimeoutStrategy<span class="token punctuation">.</span>Pessimistic<span class="token punctuation">,</span>
<span class="token keyword">async</span><span class="token punctuation">(</span>context<span class="token punctuation">,</span> timespan<span class="token punctuation">,</span> task<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
<span class="token punctuation">{</span>
	Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;timeout&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> policy<span class="token punctuation">.</span><span class="token function">ExecuteAsync</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
	Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;开始任务&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">await</span> Task<span class="token punctuation">.</span><span class="token function">Delay</span><span class="token punctuation">(</span><span class="token number">5000</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//注意不能用Thread.Sleep(5000);</span>
	Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;完成任务&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="九、-aop-框架基础"><a href="#九、-aop-框架基础" class="header-anchor">#</a> 九、 AOP 框架基础</h3> <p>要求懂的知识：AOP、Filter、反射（Attribute）。</p> <p>如果直接使用 Polly，那么就会造成业务代码中混杂大量的业务无关代码。我们使用 AOP （如果不了解 AOP，请自行参考网上资料）的方式封装一个简单的框架，模仿 Spring cloud 中的 Hystrix。</p> <p>需要先引入一个支持.Net Core 的 AOP，目前我发现的最好的.Net Core 下的 AOP 框架是 AspectCore（国产，动态织入），其他要不就是不支持.Net Core，要不就是不支持对异步方法进行 拦截。MVC Filter</p> <p>GitHub：<code>https://github.com/dotnetcore/AspectCore-Framework</code></p> <p><code>Install-Package AspectCore.Core -Version 0.5.0</code></p> <p>这里只介绍和我们相关的用法：</p> <ul><li><p>1、编写拦截器 CustomInterceptorAttribute 一般继承自 AbstractInterceptorAttribute</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">CustomInterceptorAttribute</span> <span class="token punctuation">:</span> <span class="token class-name">AbstractInterceptorAttribute</span>
<span class="token punctuation">{</span>
 	<span class="token comment">//每个被拦截的方法中执行</span>
	<span class="token keyword">public</span> <span class="token keyword">async</span> <span class="token keyword">override</span> <span class="token class-name">Task</span> <span class="token function">Invoke</span><span class="token punctuation">(</span><span class="token class-name">AspectContext</span> context<span class="token punctuation">,</span> <span class="token class-name">AspectDelegate</span> next<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token keyword">try</span>
		<span class="token punctuation">{</span>
			Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;Before service call&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//执行被拦截的方法</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span><span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;Service threw an exception!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
			<span class="token keyword">throw</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">finally</span>
		<span class="token punctuation">{</span>		
			Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;After service call&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-csharp extra-class"><pre class="language-csharp"><code>AspectContext 的属性的含义：
Implementation 实际动态创建的 Person 子类的对象。
ImplementationMethod 就是 Person 子类的 Say 方法
Parameters 方法的参数值。
Proxy<span class="token operator">==</span>Implementation：当前场景下
ProxyMethod<span class="token operator">==</span>ImplementationMethod：当前场景下
ReturnValue 返回值
ServiceMethod 是 Person 的 Say 方法
</code></pre></div></li> <li><p>2、编写需要被代理拦截的类</p> <p>在要被拦截的方法上标注 CustomInterceptorAttribute 。类需要是 public 类，方法需要是虚 方法，支持异步方法，因为动态代理是动态生成被代理的类的动态子类实现的。</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Person</span>
<span class="token punctuation">{</span>
	<span class="token punctuation">[</span><span class="token class-name">CustomInterceptor</span><span class="token punctuation">]</span>
	<span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token keyword">void</span> <span class="token function">Say</span><span class="token punctuation">(</span><span class="token keyword">string</span> msg<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;service calling...&quot;</span><span class="token operator">+</span>msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>3、通过 AspectCore 创建代理对象</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token class-name">ProxyGeneratorBuilder</span> proxyGeneratorBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProxyGeneratorBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name">IProxyGenerator</span> proxyGenerator <span class="token operator">=</span> proxyGeneratorBuilder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token class-name">Person</span> p <span class="token operator">=</span> proxyGenerator<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">CreateClassProxy</span><span class="token punctuation">&lt;</span><span class="token class-name">Person</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	p<span class="token punctuation">.</span><span class="token function">Say</span><span class="token punctuation">(</span><span class="token string">&quot;rupeng.com&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
Console<span class="token punctuation">.</span><span class="token function">ReadKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>注意 p 指向的对象是 AspectCore 生成的 Person 的动态子类的对象，直接 new Person 是无法被 拦截的。</p></li></ul> <h3 id="十、创建简单的熔断降级框架"><a href="#十、创建简单的熔断降级框架" class="header-anchor">#</a> 十、创建简单的熔断降级框架</h3> <p>要达到的目标是：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Person</span>
<span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token class-name">HystrixCommand</span><span class="token punctuation">(</span><span class="token string">&quot;HelloFallBackAsync&quot;</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
	<span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token keyword">async</span> Task<span class="token operator">&lt;</span><span class="token keyword">string</span><span class="token operator">&gt;</span> <span class="token function">HelloAsync</span><span class="token punctuation">(</span><span class="token keyword">string</span> name<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token operator">+</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token string">&quot;ok&quot;</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">public</span> <span class="token keyword">async</span> Task<span class="token operator">&lt;</span><span class="token keyword">string</span><span class="token operator">&gt;</span> <span class="token function">HelloFallBackAsync</span><span class="token punctuation">(</span><span class="token keyword">string</span> name<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;执行失败&quot;</span><span class="token operator">+</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token string">&quot;fail&quot;</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>参与降级的方法参数要一样。</p> <p>当 HelloAsync 执行出错的时候执行 HelloFallBackAsync 方法。</p> <ul><li><p>1、编写 HystrixCommandAttribute</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">using</span> AspectCore<span class="token punctuation">.</span>DynamicProxy<span class="token punctuation">;</span>
<span class="token keyword">using</span> System<span class="token punctuation">;</span>
<span class="token keyword">using</span> System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Tasks<span class="token punctuation">;</span>
<span class="token keyword">namespace</span> hystrixtest1
<span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token class-name">AttributeUsage</span><span class="token punctuation">(</span>AttributeTargets<span class="token punctuation">.</span>Method<span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HystrixCommandAttribute</span> <span class="token punctuation">:</span> <span class="token class-name">AbstractInterceptorAttribute</span>
    <span class="token punctuation">{</span>
		<span class="token keyword">public</span> <span class="token function">HystrixCommandAttribute</span><span class="token punctuation">(</span><span class="token keyword">string</span> fallBackMethod<span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			<span class="token keyword">this</span><span class="token punctuation">.</span>FallBackMethod <span class="token operator">=</span> fallBackMethod<span class="token punctuation">;</span>
		<span class="token punctuation">}</span>
		<span class="token keyword">public</span> <span class="token keyword">string</span> FallBackMethod <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
		<span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token class-name">Task</span> <span class="token function">Invoke</span><span class="token punctuation">(</span><span class="token class-name">AspectContext</span> context<span class="token punctuation">,</span> <span class="token class-name">AspectDelegate</span> next<span class="token punctuation">)</span>
		<span class="token punctuation">{</span>
			<span class="token keyword">try</span>
			<span class="token punctuation">{</span>
				<span class="token keyword">await</span> <span class="token function">next</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//执行被拦截的方法</span>
			<span class="token punctuation">}</span>
			<span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> ex<span class="token punctuation">)</span>
			<span class="token punctuation">{</span>
				<span class="token comment">//context.ServiceMethod 被拦截的方法。context.ServiceMethod.DeclaringType被拦截方法所在的类</span>
				<span class="token comment">//context.Implementation 实际执行的对象 p</span>
				<span class="token comment">//context.Parameters 方法参数值</span>
				<span class="token comment">//如果执行失败，则执行 FallBackMethod</span>
				<span class="token keyword">var</span> fallBackMethod <span class="token operator">=</span> context<span class="token punctuation">.</span>ServiceMethod<span class="token punctuation">.</span>DeclaringType<span class="token punctuation">.</span><span class="token function">GetMethod</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>FallBackMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>
				<span class="token class-name">Object</span> fallBackResult <span class="token operator">=</span> fallBackMethod<span class="token punctuation">.</span><span class="token function">Invoke</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Implementation<span class="token punctuation">,</span>context<span class="token punctuation">.</span>Parameters<span class="token punctuation">)</span><span class="token punctuation">;</span>
				context<span class="token punctuation">.</span>ReturnValue <span class="token operator">=</span> fallBackResult<span class="token punctuation">;</span>
			<span class="token punctuation">}</span>
		<span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>2、编写类</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Person</span><span class="token comment">//需要 public 类</span>
<span class="token punctuation">{</span>
	<span class="token punctuation">[</span><span class="token class-name">HystrixCommand</span><span class="token punctuation">(</span><span class="token function">nameof</span><span class="token punctuation">(</span>HelloFallBackAsync<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
	<span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token keyword">async</span> Task<span class="token operator">&lt;</span><span class="token keyword">string</span><span class="token operator">&gt;</span> <span class="token function">HelloAsync</span><span class="token punctuation">(</span><span class="token keyword">string</span> name<span class="token punctuation">)</span><span class="token comment">//需要是虚方法</span>
	<span class="token punctuation">{</span>
		Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span><span class="token operator">+</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token comment">// s.ToString();</span>
		<span class="token keyword">return</span> <span class="token string">&quot;ok&quot;</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">public</span> <span class="token keyword">async</span> Task<span class="token operator">&lt;</span><span class="token keyword">string</span><span class="token operator">&gt;</span> <span class="token function">HelloFallBackAsync</span><span class="token punctuation">(</span><span class="token keyword">string</span> name<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;执行失败&quot;</span><span class="token operator">+</span>name<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token string">&quot;fail&quot;</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token punctuation">[</span><span class="token class-name">HystrixCommand</span><span class="token punctuation">(</span><span class="token function">nameof</span><span class="token punctuation">(</span>AddFall<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
	<span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token keyword">int</span> <span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">,</span><span class="token keyword">int</span> j<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		<span class="token comment">// s.ToArray();</span>
		<span class="token keyword">return</span> i <span class="token operator">+</span> j<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">AddFall</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token keyword">int</span> j<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li> <li><p>3、创建代理对象</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token class-name">ProxyGeneratorBuilder</span> proxyGeneratorBuilder <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProxyGeneratorBuilder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token class-name">IProxyGenerator</span> proxyGenerator <span class="token operator">=</span> proxyGeneratorBuilder<span class="token punctuation">.</span><span class="token function">Build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
<span class="token punctuation">{</span>
	<span class="token class-name">Person</span> p <span class="token operator">=</span> proxyGenerator<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">CreateClassProxy</span><span class="token punctuation">&lt;</span><span class="token class-name">Person</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
	Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">HelloAsync</span><span class="token punctuation">(</span><span class="token string">&quot;yzk&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Result<span class="token punctuation">)</span><span class="token punctuation">;</span>
	Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span>p<span class="token punctuation">.</span><span class="token function">Add</span><span class="token punctuation">(</span><span class="token number">1</span><span class="token punctuation">,</span> <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>上面的代码还支持多次降级，方法上标注[HystrixCommand]并且 virtual 即可：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">Person</span><span class="token comment">//需要 public 类</span>
<span class="token punctuation">{</span>
	<span class="token punctuation">[</span><span class="token class-name">HystrixCommand</span><span class="token punctuation">(</span><span class="token function">nameof</span><span class="token punctuation">(</span>Hello1FallBackAsync<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
	<span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token keyword">async</span> Task<span class="token operator">&lt;</span><span class="token keyword">string</span><span class="token operator">&gt;</span> <span class="token function">HelloAsync</span><span class="token punctuation">(</span><span class="token keyword">string</span> name<span class="token punctuation">)</span><span class="token comment">//需要是虚方法</span>
	<span class="token punctuation">{</span>
		Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;hello&quot;</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		s<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token string">&quot;ok&quot;</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token punctuation">[</span><span class="token class-name">HystrixCommand</span><span class="token punctuation">(</span><span class="token function">nameof</span><span class="token punctuation">(</span>Hello2FallBackAsync<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
	<span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token keyword">async</span> Task<span class="token operator">&lt;</span><span class="token keyword">string</span><span class="token operator">&gt;</span> <span class="token function">Hello1FallBackAsync</span><span class="token punctuation">(</span><span class="token keyword">string</span> name<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;Hello 降级 1&quot;</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		s<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token string">&quot;fail_1&quot;</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token keyword">async</span> Task<span class="token operator">&lt;</span><span class="token keyword">string</span><span class="token operator">&gt;</span> <span class="token function">Hello2FallBackAsync</span><span class="token punctuation">(</span><span class="token keyword">string</span> name<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		Console<span class="token punctuation">.</span><span class="token function">WriteLine</span><span class="token punctuation">(</span><span class="token string">&quot;Hello 降级 2&quot;</span> <span class="token operator">+</span> name<span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> <span class="token string">&quot;fail_2&quot;</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token punctuation">[</span><span class="token class-name">HystrixCommand</span><span class="token punctuation">(</span><span class="token function">nameof</span><span class="token punctuation">(</span>AddFall<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
	<span class="token keyword">public</span> <span class="token keyword">virtual</span> <span class="token keyword">int</span> <span class="token function">Add</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token keyword">int</span> j<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token class-name">String</span> s <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
		s<span class="token punctuation">.</span><span class="token function">ToString</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
		<span class="token keyword">return</span> i <span class="token operator">+</span> j<span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
	<span class="token keyword">public</span> <span class="token keyword">int</span> <span class="token function">AddFall</span><span class="token punctuation">(</span><span class="token keyword">int</span> i<span class="token punctuation">,</span> <span class="token keyword">int</span> j<span class="token punctuation">)</span>
	<span class="token punctuation">{</span>
		<span class="token keyword">return</span> <span class="token number">0</span><span class="token punctuation">;</span>
	<span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></li></ul> <h3 id="十一、-细化框架"><a href="#十一、-细化框架" class="header-anchor">#</a> 十一、 细化框架</h3> <p>上面明白了原理，然后直接展示写好的更复杂的 HystrixCommandAttribute，讲解代码，不现场敲了。</p> <p>这是我会持续维护的开源项目</p> <p>github 最新地址 <code>https://github.com/yangzhongke/RuPeng.HystrixCore</code></p> <p>Nuget 地址：<code>https://www.nuget.org/packages/RuPeng.HystrixCore</code></p> <ul><li>重试：MaxRetryTimes 表示最多重试几次，如果为 0 则不重试，RetryIntervalMilliseconds 表示重试间隔的毫秒数；</li> <li>熔断：EnableCircuitBreaker 是否启用熔断，ExceptionsAllowedBeforeBreaking 表示熔断前出现允许错误几次，MillisecondsOfBreak 表示熔断多长时间（毫秒）；</li> <li>超时：TimeOutMilliseconds 执行超过多少毫秒则认为超时（0 表示不检测超时）</li> <li>缓存：CacheTTLMilliseconds 缓存多少毫秒（0 表示不缓存），用“类名+方法名+所有参数值ToString 拼接”做缓存 Key（唯一的要求就是参数的类型 ToString 对于不同对象一定要不一样）。</li></ul> <p>由于 CircuitBreaker 要求同一段代码必须共享同一个 Policy 对象。一般我们熔断控制是针对一个 方 法 ， 一 个 方 法 无 论 是 通 过 几 个 Person 对 象 调 用 ， 无 论 是 谁 调 用 ， 只 要 全 局 出 现ExceptionsAllowedBeforeBreaking 次错误，就会熔断，这是我框架的实现，你如果认为不合理，你自己改去。</p> <p>非常抱歉，因为我把.Net 中的 Attribute 和 Java 中类似技术的行为弄混了，在.Net 中每次获取Attribute 获取的都是新的实例。我上课讲错了，我讲的是“每次获取 Attribute 获取的都是相同实例”。下面的代码是我修改后的代码，通过 ConcurrentDictionary 来保证一个方法对应一个 Policy实例。</p> <p><code>Install-Package Microsoft.Extensions.Caching.Memory</code></p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">using</span> System<span class="token punctuation">;</span>
<span class="token keyword">using</span> AspectCore<span class="token punctuation">.</span>DynamicProxy<span class="token punctuation">;</span>
<span class="token keyword">using</span> System<span class="token punctuation">.</span>Threading<span class="token punctuation">.</span>Tasks<span class="token punctuation">;</span>
<span class="token keyword">using</span> Polly<span class="token punctuation">;</span>
<span class="token keyword">using</span> System<span class="token punctuation">.</span>Collections<span class="token punctuation">.</span>Concurrent<span class="token punctuation">;</span>
<span class="token keyword">using</span> System<span class="token punctuation">.</span>Reflection<span class="token punctuation">;</span>
<span class="token keyword">namespace</span> RuPeng<span class="token punctuation">.</span>HystrixCore
<span class="token punctuation">{</span>
    <span class="token punctuation">[</span><span class="token class-name">AttributeUsage</span><span class="token punctuation">(</span>AttributeTargets<span class="token punctuation">.</span>Method<span class="token punctuation">)</span><span class="token punctuation">]</span>
    <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">HystrixCommandAttribute</span> <span class="token punctuation">:</span> <span class="token class-name">AbstractInterceptorAttribute</span>
    <span class="token punctuation">{</span>
        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 最多重试几次，如果为0则不重试</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token keyword">public</span> <span class="token keyword">int</span> MaxRetryTimes <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 重试间隔的毫秒数</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token keyword">public</span> <span class="token keyword">int</span> RetryIntervalMilliseconds <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token number">100</span><span class="token punctuation">;</span>
        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 是否启用熔断</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token keyword">public</span> <span class="token keyword">bool</span> EnableCircuitBreaker <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">false</span><span class="token punctuation">;</span>
        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 熔断前出现允许错误几次</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token keyword">public</span> <span class="token keyword">int</span> ExceptionsAllowedBeforeBreaking <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token number">3</span><span class="token punctuation">;</span>
        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 熔断多长时间（毫秒）</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token keyword">public</span> <span class="token keyword">int</span> MillisecondsOfBreak <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token number">1000</span><span class="token punctuation">;</span>
        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 执行超过多少毫秒则认为超时（0表示不检测超时）</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token keyword">public</span> <span class="token keyword">int</span> TimeOutMilliseconds <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// 缓存多少毫秒（0表示不缓存），用“类名+方法名+所有参数ToString拼接”做缓存Key</span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token keyword">public</span> <span class="token keyword">int</span> CacheTTLMilliseconds <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> ConcurrentDictionary<span class="token operator">&lt;</span>MethodInfo<span class="token punctuation">,</span> Policy<span class="token operator">&gt;</span> policies <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token generic-method"><span class="token function">ConcurrentDictionary</span><span class="token punctuation">&lt;</span><span class="token class-name">MethodInfo</span><span class="token punctuation">,</span> <span class="token class-name">Policy</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">readonly</span> <span class="token class-name">Microsoft<span class="token punctuation">.</span>Extensions<span class="token punctuation">.</span>Caching<span class="token punctuation">.</span>Memory<span class="token punctuation">.</span>IMemoryCache</span> memoryCache
       <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Microsoft<span class="token punctuation">.</span>Extensions<span class="token punctuation">.</span>Caching<span class="token punctuation">.</span>Memory<span class="token punctuation">.</span>MemoryCache</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Microsoft<span class="token punctuation">.</span>Extensions<span class="token punctuation">.</span>Caching<span class="token punctuation">.</span>Memory<span class="token punctuation">.</span>MemoryCacheOptions</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">/// &lt;summary&gt;</span>
        <span class="token comment">/// </span>
        <span class="token comment">/// &lt;/summary&gt;</span>
        <span class="token comment">/// &lt;param name=&quot;fallBackMethod&quot;&gt;降级的方法名&lt;/param&gt;</span>
        <span class="token keyword">public</span> <span class="token function">HystrixCommandAttribute</span><span class="token punctuation">(</span><span class="token keyword">string</span> fallBackMethod<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>FallBackMethod <span class="token operator">=</span> fallBackMethod<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token keyword">string</span> FallBackMethod <span class="token punctuation">{</span> <span class="token keyword">get</span><span class="token punctuation">;</span> <span class="token keyword">set</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
        <span class="token keyword">public</span> <span class="token keyword">override</span> <span class="token keyword">async</span> <span class="token class-name">Task</span> <span class="token function">Invoke</span><span class="token punctuation">(</span><span class="token class-name">AspectContext</span> context<span class="token punctuation">,</span> <span class="token class-name">AspectDelegate</span> next<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            <span class="token comment">//一个HystrixCommand中保持一个policy对象即可</span>
            <span class="token comment">//其实主要是CircuitBreaker要求对于同一段代码要共享一个policy对象</span>
            <span class="token comment">//根据反射原理，同一个方法的MethodInfo是同一个对象，但是对象上取出来的HystrixCommandAttribute</span>
            <span class="token comment">//每次获取的都是不同的对象，因此以MethodInfo为Key保存到policies中，确保一个方法对应一个policy实例</span>
            policies<span class="token punctuation">.</span><span class="token function">TryGetValue</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>ServiceMethod<span class="token punctuation">,</span> <span class="token keyword">out</span> <span class="token class-name">Policy</span> policy<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">lock</span> <span class="token punctuation">(</span>policies<span class="token punctuation">)</span><span class="token comment">//因为Invoke可能是并发调用，因此要确保policies赋值的线程安全</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>policy <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    policy <span class="token operator">=</span> Policy<span class="token punctuation">.</span><span class="token function">NoOpAsync</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span><span class="token comment">//创建一个空的Policy</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>EnableCircuitBreaker<span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        policy <span class="token operator">=</span>
                       policy<span class="token punctuation">.</span><span class="token function">WrapAsync</span><span class="token punctuation">(</span>Policy<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Handle</span><span class="token punctuation">&lt;</span><span class="token class-name">Exception</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">CircuitBreakerAsync</span><span class="token punctuation">(</span>ExceptionsAllowedBeforeBreaking<span class="token punctuation">,</span>
                       TimeSpan<span class="token punctuation">.</span><span class="token function">FromMilliseconds</span><span class="token punctuation">(</span>MillisecondsOfBreak<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>TimeOutMilliseconds <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        policy <span class="token operator">=</span> policy<span class="token punctuation">.</span><span class="token function">WrapAsync</span><span class="token punctuation">(</span>Policy<span class="token punctuation">.</span><span class="token function">TimeoutAsync</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
                       TimeSpan<span class="token punctuation">.</span><span class="token function">FromMilliseconds</span><span class="token punctuation">(</span>TimeOutMilliseconds<span class="token punctuation">)</span><span class="token punctuation">,</span> Polly<span class="token punctuation">.</span>Timeout<span class="token punctuation">.</span>TimeoutStrategy<span class="token punctuation">.</span>Pessimistic<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>MaxRetryTimes <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        policy <span class="token operator">=</span>
                       policy<span class="token punctuation">.</span><span class="token function">WrapAsync</span><span class="token punctuation">(</span>Policy<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Handle</span><span class="token punctuation">&lt;</span><span class="token class-name">Exception</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">WaitAndRetryAsync</span><span class="token punctuation">(</span>MaxRetryTimes<span class="token punctuation">,</span> i <span class="token operator">=&gt;</span>
                       TimeSpan<span class="token punctuation">.</span><span class="token function">FromMilliseconds</span><span class="token punctuation">(</span>RetryIntervalMilliseconds<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                    <span class="token class-name">Policy</span> policyFallBack <span class="token operator">=</span> Policy
                    <span class="token punctuation">.</span><span class="token generic-method"><span class="token function">Handle</span><span class="token punctuation">&lt;</span><span class="token class-name">Exception</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span>
                    <span class="token punctuation">.</span><span class="token function">FallbackAsync</span><span class="token punctuation">(</span><span class="token keyword">async</span> <span class="token punctuation">(</span>ctx<span class="token punctuation">,</span> t<span class="token punctuation">)</span> <span class="token operator">=&gt;</span>
                    <span class="token punctuation">{</span>
                        <span class="token class-name">AspectContext</span> aspectContext <span class="token operator">=</span> <span class="token punctuation">(</span>AspectContext<span class="token punctuation">)</span>ctx<span class="token punctuation">[</span><span class="token string">&quot;aspectContext&quot;</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
                        <span class="token keyword">var</span> fallBackMethod <span class="token operator">=</span>
    context<span class="token punctuation">.</span>ServiceMethod<span class="token punctuation">.</span>DeclaringType<span class="token punctuation">.</span><span class="token function">GetMethod</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>FallBackMethod<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token class-name">Object</span> fallBackResult <span class="token operator">=</span> fallBackMethod<span class="token punctuation">.</span><span class="token function">Invoke</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>Implementation<span class="token punctuation">,</span>
    context<span class="token punctuation">.</span>Parameters<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        <span class="token comment">//不能如下这样，因为这是闭包相关，如果这样写第二次调用Invoke的时候context指向的</span>
                        <span class="token comment">//还是第一次的对象，所以要通过Polly的上下文来传递AspectContext</span>
                        <span class="token comment">//context.ReturnValue = fallBackResult;</span>
                        aspectContext<span class="token punctuation">.</span>ReturnValue <span class="token operator">=</span> fallBackResult<span class="token punctuation">;</span>
                    <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token keyword">async</span> <span class="token punctuation">(</span>ex<span class="token punctuation">,</span> t<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    policy <span class="token operator">=</span> policyFallBack<span class="token punctuation">.</span><span class="token function">WrapAsync</span><span class="token punctuation">(</span>policy<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//放入</span>
                    policies<span class="token punctuation">.</span><span class="token function">TryAdd</span><span class="token punctuation">(</span>context<span class="token punctuation">.</span>ServiceMethod<span class="token punctuation">,</span> policy<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token comment">//把本地调用的AspectContext传递给Polly，主要给FallbackAsync中使用，避免闭包的坑</span>
            <span class="token class-name">Context</span> pollyCtx <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Context</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            pollyCtx<span class="token punctuation">[</span><span class="token string">&quot;aspectContext&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> context<span class="token punctuation">;</span>
            <span class="token comment">//Install-Package Microsoft.Extensions.Caching.Memory</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>CacheTTLMilliseconds <span class="token operator">&gt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
            <span class="token punctuation">{</span>
                <span class="token comment">//用类名+方法名+参数的下划线连接起来作为缓存key</span>
                <span class="token keyword">string</span> cacheKey <span class="token operator">=</span> <span class="token string">&quot;HystrixMethodCacheManager_Key_&quot;</span> <span class="token operator">+</span>
               context<span class="token punctuation">.</span>ServiceMethod<span class="token punctuation">.</span>DeclaringType
                <span class="token operator">+</span> <span class="token string">&quot;.&quot;</span> <span class="token operator">+</span>
               context<span class="token punctuation">.</span>ServiceMethod <span class="token operator">+</span> <span class="token keyword">string</span><span class="token punctuation">.</span><span class="token function">Join</span><span class="token punctuation">(</span><span class="token string">&quot;_&quot;</span><span class="token punctuation">,</span> context<span class="token punctuation">.</span>Parameters<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token comment">//尝试去缓存中获取。如果找到了，则直接用缓存中的值做返回值</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>memoryCache<span class="token punctuation">.</span><span class="token function">TryGetValue</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">,</span> <span class="token keyword">out</span> <span class="token keyword">var</span> cacheValue<span class="token punctuation">)</span><span class="token punctuation">)</span>
                <span class="token punctuation">{</span>
                    context<span class="token punctuation">.</span>ReturnValue <span class="token operator">=</span> cacheValue<span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
                <span class="token keyword">else</span>
                <span class="token punctuation">{</span>
                    <span class="token comment">//如果缓存中没有，则执行实际被拦截的方法</span>
                    <span class="token keyword">await</span> policy<span class="token punctuation">.</span><span class="token function">ExecuteAsync</span><span class="token punctuation">(</span>ctx <span class="token operator">=&gt;</span> <span class="token function">next</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">,</span> pollyCtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">//存入缓存中</span>
                    <span class="token keyword">using</span> <span class="token punctuation">(</span><span class="token keyword">var</span> cacheEntry <span class="token operator">=</span> memoryCache<span class="token punctuation">.</span><span class="token function">CreateEntry</span><span class="token punctuation">(</span>cacheKey<span class="token punctuation">)</span><span class="token punctuation">)</span>
                    <span class="token punctuation">{</span>
                        cacheEntry<span class="token punctuation">.</span>Value <span class="token operator">=</span> context<span class="token punctuation">.</span>ReturnValue<span class="token punctuation">;</span>
                        cacheEntry<span class="token punctuation">.</span>AbsoluteExpiration <span class="token operator">=</span> DateTime<span class="token punctuation">.</span>Now <span class="token operator">+</span>
                        TimeSpan<span class="token punctuation">.</span><span class="token function">FromMilliseconds</span><span class="token punctuation">(</span>CacheTTLMilliseconds<span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">else</span><span class="token comment">//如果没有启用缓存，就直接执行业务方法</span>
            <span class="token punctuation">{</span>
                <span class="token keyword">await</span> policy<span class="token punctuation">.</span><span class="token function">ExecuteAsync</span><span class="token punctuation">(</span>ctx <span class="token operator">=&gt;</span> <span class="token function">next</span><span class="token punctuation">(</span>context<span class="token punctuation">)</span><span class="token punctuation">,</span> pollyCtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>没必要、也不可能把所有 Polly 都封装到 Hystrix 中。框架不是万能的，不用过度框架，过度框 架带来的复杂度陡增，从人人喜欢变成人人恐惧。</p> <h3 id="十二、-结合-asp-net-core-依赖注入"><a href="#十二、-结合-asp-net-core-依赖注入" class="header-anchor">#</a> 十二、 结合 asp.net core 依赖注入</h3> <p>在 asp.net core 项目中，可以借助于 asp.net core 的依赖注入，简化代理类对象的注入，不用 再自己调用 ProxyGeneratorBuilder 进行代理类对象的注入了。</p> <p><code>Install-Package AspectCore.Extensions.DependencyInjection</code></p> <p>修改 Startup.cs 的 ConfigureServices 方法，把返回值从 void 改为 IServiceProvider</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">using</span> AspectCore<span class="token punctuation">.</span>Extensions<span class="token punctuation">.</span>DependencyInjection<span class="token punctuation">;</span>
<span class="token keyword">public</span> <span class="token class-name">IServiceProvider</span> <span class="token function">ConfigureServices</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    services<span class="token punctuation">.</span><span class="token function">AddMvc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    services<span class="token punctuation">.</span><span class="token generic-method"><span class="token function">AddSingleton</span><span class="token punctuation">&lt;</span><span class="token class-name">Person</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> services<span class="token punctuation">.</span><span class="token function">BuildAspectCoreServiceProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>其 中 services.AddSingleton(); 表 示 把 Person 注 入 。 BuildAspectCoreServiceProvider 是让 aspectcore 接管注入。</p> <p>在 Controller 中就可以通过构造函数进行依赖注入了：</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">ValuesController</span> <span class="token punctuation">:</span> <span class="token class-name">Controller</span>
<span class="token punctuation">{</span>
    <span class="token keyword">private</span> <span class="token class-name">Person</span> p<span class="token punctuation">;</span>
    <span class="token keyword">public</span> <span class="token function">ValuesController</span><span class="token punctuation">(</span><span class="token class-name">Person</span> p<span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>p <span class="token operator">=</span> p<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>当然要通过反射扫描所有 Service 类，只要类中有标记了 CustomInterceptorAttribute 的方法 都算作服务实现类。为了避免一下子扫描所有类，所以 RegisterServices 还是手动指定从哪个程序集中加载。</p> <div class="language-csharp extra-class"><pre class="language-csharp"><code><span class="token keyword">public</span> <span class="token class-name">IServiceProvider</span> <span class="token function">ConfigureServices</span><span class="token punctuation">(</span><span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    services<span class="token punctuation">.</span><span class="token function">AddMvc</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">RegisterServices</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">GetType</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Assembly<span class="token punctuation">,</span> services<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> services<span class="token punctuation">.</span><span class="token function">BuildAspectCoreServiceProvider</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">RegisterServices</span><span class="token punctuation">(</span><span class="token class-name">Assembly</span> asm<span class="token punctuation">,</span> <span class="token class-name">IServiceCollection</span> services<span class="token punctuation">)</span>
<span class="token punctuation">{</span>
    <span class="token comment">//遍历程序集中的所有 public 类型</span>
    <span class="token keyword">foreach</span> <span class="token punctuation">(</span><span class="token class-name">Type</span> type <span class="token keyword">in</span> asm<span class="token punctuation">.</span><span class="token function">GetExportedTypes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">{</span>
        <span class="token comment">//判断类中是否有标注了 CustomInterceptorAttribute 的方法</span>
        <span class="token keyword">bool</span> hasCustomInterceptorAttr <span class="token operator">=</span> type<span class="token punctuation">.</span><span class="token function">GetMethods</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
         <span class="token punctuation">.</span><span class="token function">Any</span><span class="token punctuation">(</span>m <span class="token operator">=&gt;</span> m<span class="token punctuation">.</span><span class="token function">GetCustomAttribute</span><span class="token punctuation">(</span><span class="token keyword">typeof</span><span class="token punctuation">(</span>CustomInterceptorAttribute<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>hasCustomInterceptorAttr<span class="token punctuation">)</span>
        <span class="token punctuation">{</span>
            services<span class="token punctuation">.</span><span class="token function">AddSingleton</span><span class="token punctuation">(</span>type<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>RestTemplate+Hystrix+之前测试用的两个微服务，结合到一起组合演示一下。</p> <p>如鹏网《.Net微服务》-by杨中科</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time"> 2019年 12月 28日 15:53:50</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/post/oldblog/微服务-Ocelot API 网关.html" class="prev">微服务 - Ocelot API 网关</a></span> <span class="next"><a href="/post/oldblog/Redis-CSharp-Driver.html">Redis C# Driver - StackExchange.Redis</a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/assets/js/app.fa3e3824.js" defer></script><script src="/assets/js/2.230529bd.js" defer></script><script src="/assets/js/35.90c07cc0.js" defer></script>
  </body>
</html>
